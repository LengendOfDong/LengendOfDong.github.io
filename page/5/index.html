<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lengendofdong.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://lengendofdong.github.io/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://lengendofdong.github.io/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="history fa-fw"></i>Archives</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="list fa-fw"></i>Categories</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-tools"><a href="/categories/%E5%B7%A5%E5%85%B7%E8%B5%84%E6%BA%90/" rel="section"><i class="briefcase fa-fw"></i>tools</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>About</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="John Doe"
      src="/images/1.webp">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">136</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SprintBoot%E4%B8%8A%E4%BC%A0%E9%99%84%E4%BB%B6%E5%A4%AA%E5%A4%A7%E6%8A%A5%E9%94%99-org.apache.tomcat.util.http.fileupload.FileUploadBase$SizeLimitExceededException/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SprintBoot%E4%B8%8A%E4%BC%A0%E9%99%84%E4%BB%B6%E5%A4%AA%E5%A4%A7%E6%8A%A5%E9%94%99-org.apache.tomcat.util.http.fileupload.FileUploadBase$SizeLimitExceededException/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SprintBoot上传附件太大报错：org-apache-tomcat-util-http-fileupload-FileUploadBase-SizeLimitExceededException"><a href="#原创：SprintBoot上传附件太大报错：org-apache-tomcat-util-http-fileupload-FileUploadBase-SizeLimitExceededException" class="headerlink" title="原创：SprintBoot上传附件太大报错：org.apache.tomcat.util.http.fileupload.FileUploadBase$SizeLimitExceededException"></a>原创：SprintBoot上传附件太大报错：org.apache.tomcat.util.http.fileupload.FileUploadBase$SizeLimitExceededException</h1><p>报错信息如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.multipart.MultipartException: Could not parse multipart servlet request; nested exception is java.lang.IllegalStateException: org.apache.tomcat.util.http.fileupload.FileUploadBase$SizeLimitExceededException:the request was rejected because its size (553963927) exceeds the configured maximum (10485760)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>报错原因：<br/><br>本人项目中附件上传默认为10MB，但是现在需要上传500多MB的文件（报错原因中已经体现）<br/><br>错误解决：<br/><br>启动类原来代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class IuirancliApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(IuirancliApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改后启动类代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class IuirancliApplication &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public MultipartConfigElement multipartConfigElement() &#123;</span><br><span class="line">		MultipartConfigFactory factory = new MultipartConfigFactory();</span><br><span class="line">		//Max size of one file</span><br><span class="line">		factory.setMaxFileSize(&quot;1000MB&quot;); //KB,MB</span><br><span class="line">		/// Max Size of All files</span><br><span class="line">		factory.setMaxRequestSize(&quot;1000MB&quot;);</span><br><span class="line">		return factory.createMultipartConfig();</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(IuirancliApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>就是在启动类加入了单个文件最大大小和总文件大小设置，加一个方法即可解决问题，亲测有效。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-Spring%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%92%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-Spring%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%92%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：Spring整体架构和环境搭建"><a href="#原创：Spring整体架构和环境搭建" class="headerlink" title="原创：Spring整体架构和环境搭建"></a>原创：Spring整体架构和环境搭建</h1><h1 id="Spring的整体架构"><a href="#Spring的整体架构" class="headerlink" title="Spring的整体架构"></a>Spring的整体架构</h1><p>Spring框架是一个分层架构，它包含一系列的功能要素，并被分为大约20个模块。<br/><br>这些模块被总结为以下几个部分：<br/><br>1）Core Container<br/><br>Core Container(核心容器)包含有Core、Beans、Context和Expression Language模块。<br/><br>Core和Beans模块是框架的基础部分，提供IoC(转控制）和依赖注入特性。这里的基础概念是BeanFactory,它提供对Factory模式的经典实现来消除对程序性单例模式的需要，并真正允许你从程序逻辑中分离出依赖关系和配置。</p>
<li>Test<br/>
Test模块支持使用JUnit和TestNG对Spring组件进行测试。</li>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SpringCloud%E6%89%93%E6%88%90Jar%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SpringCloud%E6%89%93%E6%88%90Jar%E5%8C%85/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SpringCloud打成Jar包"><a href="#原创：SpringCloud打成Jar包" class="headerlink" title="原创：SpringCloud打成Jar包"></a>原创：SpringCloud打成Jar包</h1><p>起初我都是通过在application.properties中配置参数来启动项目,但是这样有个弊端,就是同一个项目启动多次,只是端口或者环境变量不同的时候,就需要多个项目来完成<br/><br>解决这个弊端的一个好办法就是用jar包启动,通过指令来修改配置<br/><br>1.修改配置<br/><br>原来的配置是这样:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;build&amp;gt;</span><br><span class="line">		&amp;lt;plugins&amp;gt;</span><br><span class="line">			&amp;lt;plugin&amp;gt;</span><br><span class="line">				&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">				&amp;lt;artifactId&amp;gt;spring-boot-maven-plugin&amp;lt;/artifactId&amp;gt;</span><br><span class="line">			&amp;lt;/plugin&amp;gt;</span><br><span class="line">		&amp;lt;/plugins&amp;gt;</span><br><span class="line">&amp;lt;/build&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在的配置是这样:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;build&amp;gt;</span><br><span class="line">		&amp;lt;plugins&amp;gt;</span><br><span class="line">			&amp;lt;plugin&amp;gt;</span><br><span class="line">				&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">				&amp;lt;artifactId&amp;gt;spring-boot-maven-plugin&amp;lt;/artifactId&amp;gt;</span><br><span class="line">				&amp;lt;version&amp;gt;2.0.3.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">				&amp;lt;executions&amp;gt;</span><br><span class="line">					&amp;lt;execution&amp;gt;</span><br><span class="line">						&amp;lt;goals&amp;gt;</span><br><span class="line">							&amp;lt;goal&amp;gt;repackage&amp;lt;/goal&amp;gt;</span><br><span class="line">						&amp;lt;/goals&amp;gt;</span><br><span class="line">					&amp;lt;/execution&amp;gt;</span><br><span class="line">				&amp;lt;/executions&amp;gt;</span><br><span class="line">			&amp;lt;/plugin&amp;gt;</span><br><span class="line">		&amp;lt;/plugins&amp;gt;</span><br><span class="line">	&amp;lt;/build&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对比一下,只是增加了version和executions<br/><br>2.启动命令<br/><br>在控制台中输入<code>mvn clean package</code>,打包成功<br/><br><img alt="springcloud  jar" src="https://img-blog.csdnimg.cn/20190317143510938.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>3.运行jar包<br/><br>这个时候就可以随意修改运行时的参数了<br/><br><code>java -jar xxx.jar --server.port=1111</code><br/><br><code>java -jar xxx.jar --server.port=2222</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF-Spring%20Cloud%20Bus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF-Spring%20Cloud%20Bus/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–消息总线-Spring-Cloud-Bus"><a href="#原创：SPRING-CLOUD微服务实战笔记–消息总线-Spring-Cloud-Bus" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–消息总线:Spring Cloud Bus"></a>原创：SPRING CLOUD微服务实战笔记–消息总线:Spring Cloud Bus</h1><h3 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h3><h1 id="消息代理"><a href="#消息代理" class="headerlink" title="消息代理"></a>消息代理</h1><p>消息代理是一种消息验证、传输、路由的架构模式。</p>
<h1 id="RabbitMQ实现消息总线"><a href="#RabbitMQ实现消息总线" class="headerlink" title="RabbitMQ实现消息总线"></a>RabbitMQ实现消息总线</h1><p>消息投递到队列的整个过程如下：<br/><br>1.客户端连接到消息队列服务器，打开一个Channel<br/><br>2.客户端声明一个Exchange，并设置相关属性<br/><br>3.客户端声明一个Queue,并设置相关属性<br/><br>4.客户端使用RoutingKey，在Exchange和Queue之间建立好绑定关系<br/><br>5.客户端投递消息到Exchange<br/><br>6.Exchange接收到消息后，根据消息的Key和已经设置的Binding，进行消息路由，将消息投递到一个或多个Queue中<br/><br>Exchange有几种类型：<br/><br>1.Direct交换机:完全根据Key进行投递<br/><br>2.Topic交换机:对Key进行模式匹配后进行投递，可以使用符号#匹配一个或多个词，符号*匹配正好一个词<br/><br>3.Fanout交换机:不需要任何Key,它采取广播的模式，一个消息进来时，投递到与该交换机绑定的所有队列</p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>在Spring Boot中整合RabbitMQ,pom中AMQP模块可以很好地支持RabbitMQ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-amqp&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-test&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=rabbitmq-hello</span><br><span class="line">spring.rabbitmq.host=localhost</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=springcloud</span><br><span class="line">spring.rabbitmq.password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class Sender &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private AmqpTemplate rabbitTemplate;</span><br><span class="line">    public void send()&#123;</span><br><span class="line">        String context = &quot;hello&quot; + new Date();</span><br><span class="line">        System.out.println(&quot;Sender: &quot; + context);</span><br><span class="line">        this.rabbitTemplate.convertAndSend(&quot;hello&quot;,context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@RabbitListener(queues = &quot;hello&quot;)</span><br><span class="line">public class Receiver &#123;</span><br><span class="line">    @RabbitHandler</span><br><span class="line">    public void process(String hello)&#123;</span><br><span class="line">        System.out.println(&quot;Receiver: &quot; + hello);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.amqp.core.Queue;</span><br><span class="line">@Configuration</span><br><span class="line">public class RabbitConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public Queue helloQueue()&#123;</span><br><span class="line">        return new Queue(&quot;hello&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class HelloApplicationTests &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private Sender sender;</span><br><span class="line">	@Test</span><br><span class="line">	public void hello() throws Exception&#123;</span><br><span class="line">		sender.send();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.amqp.AmqpConnectException: java.net.ConnectException: Connection refused (Connection refused)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里不得不提下这个问题，书中没有提到这个问题，所以自己想办法解决了，首先打开RabbitMQ的管理界面可以看到springcloud处于<code>No access</code>状态<br/><br><img alt="No access" src="https://img-blog.csdnimg.cn/20190331153234605.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>给springcloud用户添加权限，单击<code>springcloud</code>，进入下图<img alt="Set permission" src="https://img-blog.csdnimg.cn/20190331154135508.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>单击Set permission，此时springcloud用户获取到权限了<br/><br><img alt="Set permission2" src="https://img-blog.csdnimg.cn/20190331154331915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br><img alt="have permission" src="https://img-blog.csdnimg.cn/20190331154449182.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Created new connection: rabbitConnectionFactory#2b608c2a:0/SimpleConnection@5e53c92d [delegate=amqp://springcloud@127.0.0.1:5672/, localPort= 49700]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="整合Spring-Cloud-Bus"><a href="#整合Spring-Cloud-Bus" class="headerlink" title="整合Spring Cloud Bus"></a>整合Spring Cloud Bus</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-bus-amqp&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.3.4.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.rabbitmq.host=localhost</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=springcloud</span><br><span class="line">spring.rabbitmq.password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p><img alt="原理分析" src="https://img-blog.csdnimg.cn/20190331221613667.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>这里主要是通过消息总线的方式，将其中一个实例的更新请求<code>/bus/refresh</code>，传递给其他实例，达到同时刷新的目的</p>
<h2 id="指定刷新范围"><a href="#指定刷新范围" class="headerlink" title="指定刷新范围"></a>指定刷新范围</h2><p>特别情况下，希望可以刷新微服务中某个具体实例的配置<br/><br>通过<code>/bus/refresh?destination=customers:9000</code>来刷新某个具体的实例，<code>customers:9000</code>指的是各个微服务的ApplicationContext ID<br/><br>默认情况下，ApplicationContext ID是<code>spring.application.name:server.port</code>，详见<code>org.springframework.boot.context.ContextIdApplicationContextInitializer.getApplicationId(ConfigurableEnvironment)</code>方法。<br/><br>destination参数也可以用来定位特定的微服务。例如：<code>/bus/refresh?destination=customers:**</code>，这样就可以触发customers微服务所有实例的配置刷新。</p>
<h2 id="架构优化"><a href="#架构优化" class="headerlink" title="架构优化"></a>架构优化</h2><p>在之前的架构中，服务是不对等的，如果固定向某个实例发送刷新请求，再触发整个服务集群的刷新，这种方式会造成运维工作的复杂性。若此服务实例发生迁移，则会造成配置不能刷新的潜在后果。<br/><br>架构调整可以做如下改动：<br/><br>1.在Config Server中也引入Spring Cloud Bus,将配置服务端也加入到消息总线中来<br/><br>2.&#x2F;bus&#x2F;refresh请求不再发送到具体服务实例上，而是发送给Config Server，并通过<br/><br>destination参数来指定需要更新配置的服务实例<br/><br>对于Git的触发等配置只需要针对Config Server即可，从而简化了集群上的一些维护工作</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1-Spring%20Cloud%20Stream/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1-Spring%20Cloud%20Stream/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–消息驱动的微服务-Spring-Cloud-Stream"><a href="#原创：SPRING-CLOUD微服务实战笔记–消息驱动的微服务-Spring-Cloud-Stream" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–消息驱动的微服务:Spring Cloud Stream"></a>原创：SPRING CLOUD微服务实战笔记–消息驱动的微服务:Spring Cloud Stream</h1><h3 id="Spring-Cloud-Stream"><a href="#Spring-Cloud-Stream" class="headerlink" title="Spring Cloud Stream"></a>Spring Cloud Stream</h3><h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-stream-rabbit&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.3.4.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-test&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@EnableBinding(Sink.class)</span><br><span class="line">public class SinkReceiver &#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(HelloApplication.class);</span><br><span class="line">    @StreamListener(Sink.INPUT)</span><br><span class="line">    public void receive(Object payload)&#123;</span><br><span class="line">        logger.info(&quot;Received: &quot; + payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Received: [B@7236cac6</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>刚才我们在RabbitMQ管理界面发布的信息，由SinkReceiver来消费了<br/><br>说一下定义在SinkReceiver的Spring Cloud Stream的核心注解<br/><br><code>@EnableBinding</code>:该注解用来指定一个或多个定义了@Input或@Output注解的接口，以此来实现对消息通道（Channel）的绑定。<br/><br><code>@StreamListener</code>：该注解主要定义在方法上，作用是将被修饰的方法注册为消息中间上数据流的事件监听器，注解中属性值对应了监听的消息通道名。<br/><br>第一个注解主要用来将当前类<code>SinkReceiver</code>绑定到<code>Sink.class</code>上，而<code>Sink.class</code>已经绑定input通道，第二个注解主要监听input通道上的数据</p>
<h1 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h1><p>Spring Cloud Stream构建的应用程序与消息中间件之间是通过绑定器Binder相关联的，绑定器对于应用程序而言起到了隔离作用，它使得不同消息中间件的实现细节对应用程序来说是透明的。如下图所示，绑定器是作为通道和消息中间件之间的桥梁进行通信<br/><br><img alt="Binder" src="https://img-blog.csdnimg.cn/20190402155040334.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h2 id="绑定器"><a href="#绑定器" class="headerlink" title="绑定器"></a>绑定器</h2><p>绑定器与数据库中的DataSource相同，在连接数据库时有很多数据库厂家，每个厂家的实现数据源细节都不尽相同，所以将数据源抽象成DataSource接口，就可以将具体实现细节进行隔离。此处的绑定器与其有相同的效果，由于各消息中间件构建的初衷不同，在实现细节上也有很大差异。通过定义绑定器作为中间层，完美地实现了应用程序与消息中间件细节之间的隔离。<br/><br>通过向应用程序暴露统一的Channel通道，不需要再考虑各种不同的消息中间件的实现。当需要更换其他消息中间件时，要做的就是更换它们对应的Binder绑定器而不需要修改任何SpringBoot的应用逻辑。</p>
<h2 id="发布-订阅模式"><a href="#发布-订阅模式" class="headerlink" title="发布-订阅模式"></a>发布-订阅模式</h2><p>Spring Cloud Stream中的消息通信方式遵循了发布-订阅模式，当一条消息被投递到消息中间件之后，它会通过共享的Topic主题进行广播，消息消费者在订阅的主题中收到它并触发自身的业务逻辑处理。<br/><br>生产者 生产消息发布在shared topic（共享主题）上，然后 消费者 通过订阅这个topic来获取消息<br/><br><img alt="发布订阅模式" src="https://img-blog.csdnimg.cn/20190402161514452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>在RabbitMQ中，Topic对应Exchange,在Kafka中对应Kafka中的Topic</p>
<h2 id="消费组"><a href="#消费组" class="headerlink" title="消费组"></a>消费组</h2><p>在现实的微服务架构中，每一个微服务应用为了实现高可用和负载均衡，实际上都会部署多个实例。<br/><br>如果在同一个主题上的应用需要启动多个实例时，可以通过<code>spring.cloud.stream.bindings.input.group</code>属性为应用指定一个组名，这样一个组里只有一个成员真正接收到消息并进行处理。<br/><br><img alt="消费组" src="https://img-blog.csdnimg.cn/20190402163121925.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h2 id="消息分区"><a href="#消息分区" class="headerlink" title="消息分区"></a>消息分区</h2><p>对于同一条消息，多次到达之后可能是由不同的实例进行消费的。<br/><br>对于一些场景，需要对一些具有相同特征的消息设置每次都被同一个消费实例处理<br/><br>分区概念的引入就是为了解决这样的问题：当生产者将消息数据发送给多个消费者实例时，保证拥有共同特征的消息数据始终是由同一个消费者实例接收和处理。</p>
<h1 id="使用详解"><a href="#使用详解" class="headerlink" title="使用详解"></a>使用详解</h1><p>@EnableBinding注解用来创建消息通道的绑定</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">//注解后会成为Spring的基本配置类</span><br><span class="line">@Configuration</span><br><span class="line">//加载Spring Cloud Stream运行需要的几个基础配置类</span><br><span class="line">@Import(&#123;BindingServiceConfiguration.class, BindingBeansRegistrar.class, BinderFactoryConfiguration.class, SpelExpressionConverterConfiguration.class&#125;)</span><br><span class="line">@EnableIntegration</span><br><span class="line">public @interface EnableBinding &#123;</span><br><span class="line">    Class&amp;lt;?&amp;gt;[] value() default &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="绑定消息通道"><a href="#绑定消息通道" class="headerlink" title="绑定消息通道"></a>绑定消息通道</h2><h3 id="注入绑定接口"><a href="#注入绑定接口" class="headerlink" title="注入绑定接口"></a>注入绑定接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public interface SinkSender &#123;</span><br><span class="line">    @Output(Source.OUTPUT)</span><br><span class="line">    MessageChannel output();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@EnableBinding(value = &#123;Sink.class, SinkSender.class&#125;)</span><br><span class="line">public class SinkReceiver &#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(SinkSender.class);</span><br><span class="line">    @StreamListener(Sink.INPUT)</span><br><span class="line">    public void receive(Object payload)&#123;</span><br><span class="line">        logger.info(&quot;Received: &quot; + payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.bindings.input.destination=raw-sensor-data</span><br><span class="line">spring.cloud.stream.bindings.output.destination=raw-sensor-data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">@WebAppConfiguration</span><br><span class="line">public class HelloApplicationTests &#123;</span><br><span class="line">	@Autowired</span><br><span class="line">	private SinkSender sinkSender;</span><br><span class="line">	@Test</span><br><span class="line">	public void contextLoads() &#123;</span><br><span class="line">		sinkSender.output().send(MessageBuilder.withPayload(&quot;From SinkSender&quot;).build());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="注入消息通道"><a href="#注入消息通道" class="headerlink" title="注入消息通道"></a>注入消息通道</h3><p>在测试类中加入下面内容，用于注入消息通道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private MessageChannel input;</span><br><span class="line">@Test</span><br><span class="line">public void contextLoads1()&#123;</span><br><span class="line">	input.send(MessageBuilder.withPayload(&quot;From MessageChannel&quot;).build());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="消费组与消息分区"><a href="#消费组与消息分区" class="headerlink" title="消费组与消息分区"></a>消费组与消息分区</h2><p>1.消费组<br/><br>有些业务场景下，希望生产者产生的消息只被一个实例消费，这个时候就需要为这些消费者设置消费组来实现这样的功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@EnableBinding(value = &#123;Sink.class&#125;)</span><br><span class="line">public class SinkReceiver &#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(SinkReceiver.class);</span><br><span class="line">    @StreamListener(Sink.INPUT)</span><br><span class="line">    public void receive(User user)&#123;</span><br><span class="line">        logger.info(&quot;Received: &quot; + user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.bindings.input.group=Service-A</span><br><span class="line">spring.cloud.stream.bindings.input.destination=greetings</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这其中<code>spring.cloud.stream.bindings.input.group</code>属性指定了该应用实例都属于Service-A消费组，而<code>spring.cloud.stream.bindings.input.destination</code>属性则指定了输入通道对应的主题名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@EnableBinding(value = &#123;Source.class&#125;)</span><br><span class="line">public class SinkSender &#123;</span><br><span class="line">    private static Logger logger = LoggerFactory.getLogger(SinkSender.class);</span><br><span class="line">    @Bean</span><br><span class="line">    @InboundChannelAdapter(value = Source.OUTPUT,poller = @Poller(fixedDelay = &quot;2000&quot;))</span><br><span class="line">    public MessageSource&amp;lt;String&amp;gt; timerMessageSource()&#123;</span><br><span class="line">        return ()-&amp;gt;new GenericMessage&amp;lt;&amp;gt;(&quot;&#123;\&quot;name\&quot;:\&quot;didi\&quot;,\&quot;age\&quot;:30&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.bindings.output.destination=greetings</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动多个消费者实例，再启动生产者实例，通过输出可以看到生产者发出的消息会被启动的消费者以轮询的方式进行接收和输出<br/><br><img alt="消费者交替" src="https://img-blog.csdnimg.cn/20190402232015744.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>2.消息分区<br/><br>消费组只是保证了同一消息只被一个消费者实例进行接收和处理，但是不能保证消息总能被同一个实例进行消费。这个时候需要对消息进行分区处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.bindings.input.group=Service-A</span><br><span class="line">spring.cloud.stream.bindings.input.destination=greetings</span><br><span class="line">spring.cloud.stream.bindings.input.consumer.partitioned=true</span><br><span class="line">spring.cloud.stream.instance-count=2</span><br><span class="line">spring.cloud.stream.instance-index=0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>spring.cloud.stream.bindings.input.consumer.partitioned</code>:通过该参数开启消费者分区功能<br/><br><code>spring.cloud.stream.instanceCount</code>:该参数指定了当前消费者的总实例数量<br/><br><code>spring.cloud.stream.instanceIndex</code>:该参数设置当前实例的索引号，从0开始，最大值为<code>spring.cloud.stream.instanceCount</code>参数-1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.bindings.output.producer.partitionKeyExpression=payload</span><br><span class="line">spring.cloud.stream.bindings.output.producer.partitionCount=2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>spring.cloud.stream.bindings.output.producer.partitionKeyExpression</code>:通过该参数指定了分区键的表达式规则，我们可以根据实际的输出消息规则SpEL来生成合适的分区键<br/><br><code>spring.cloud.stream.bindings.output.producer.partitionCount</code>:该参数指定了消息分区的数量<br/><br><code>spring.cloud.stream.bindings.output.producer.partition-key-expression=1</code> 表示只有分区ID为1的消费端能接收到信息。<br/><br><code>spring.cloud.stream.bindings.output.producer.partition-key-expression=0</code> 表示只有分区ID为0的消费端能接收到信息。</p>
<h2 id="消息类型"><a href="#消息类型" class="headerlink" title="消息类型"></a>消息类型</h2><p>目前，Spring Cloud Stream中自带支持了以下几种常用的消息类型转换：</p>
<h1 id="绑定器详解"><a href="#绑定器详解" class="headerlink" title="绑定器详解"></a>绑定器详解</h1><h2 id="多绑定器配置"><a href="#多绑定器配置" class="headerlink" title="多绑定器配置"></a>多绑定器配置</h2><p>在一个应用程序中使用多个绑定器时，往往其中一个绑定器会是主要使用的，而第二个可能是为了适应一些特殊要求（比如性能等原因）。可以先通过设置默认绑定器来为大部分的通道设置绑定器。比如，使用RabbitMQ设置默认绑定器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.defaultBinder=rabbit</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在设置默认绑定器之后，再为其他一些少数的消息通道单独设置绑定器，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.bindings.input.binder=kafka</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当需要在一个应用程序中使用同一类型不同环境的绑定器时，可以通过配置实现通道绑定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.stream.bindings.input.binder=rabbit1</span><br><span class="line">spring.cloud.stream.bindings.input.binder=rabbit2</span><br><span class="line">#rabbit1的通道类型为rabbit</span><br><span class="line">spring.cloud.stream.binders.rabbit1.type=rabbit</span><br><span class="line">spring.cloud.stream.binders.rabbit1.environment.spring.rabbitmq.host=192.168.0.101</span><br><span class="line">spring.cloud.stream.binders.rabbit1.environment.spring.rabbitmq.port=5672</span><br><span class="line">#rabbit2的通道类型为rabbit</span><br><span class="line">spring.cloud.stream.binders.rabbit2.type=rabbit</span><br><span class="line">spring.cloud.stream.binders.rabbit2.environment.spring.rabbitmq.host=192.168.0.102</span><br><span class="line">spring.cloud.stream.binders.rabbit2.environment.spring.rabbitmq.port=5672</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面的配置中，可以看出rabbit1和rabbit2的通道类型都为rabbit,只是主机地址不同。<br/><br>当采用显示配置方式时会自动禁用默认的绑定器配置，所以当定义了显示配置以后，对于这些绑定器的配置需要通过spring.cloud.stream.binders.属性来进行设置。对于绑定器的配置 主要有下面4个参数：</p>
<h2 id="RabbitMQ与Kafka绑定器"><a href="#RabbitMQ与Kafka绑定器" class="headerlink" title="RabbitMQ与Kafka绑定器"></a>RabbitMQ与Kafka绑定器</h2><p>RabbitMQ与Kafka的绑定器是如何使用消息中间件中不同概念来实现消息的生产与消费的：</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%84%E5%BB%BA-Spring%20Boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%84%E5%BB%BA-Spring%20Boot/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–微服务构建-Spring-Boot"><a href="#原创：SPRING-CLOUD微服务实战笔记–微服务构建-Spring-Boot" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–微服务构建:Spring Boot"></a>原创：SPRING CLOUD微服务实战笔记–微服务构建:Spring Boot</h1><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>1.实现RESTful API</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HelloController&#123;</span><br><span class="line">	@RequestMapping(&quot;/hello&quot;)</span><br><span class="line">	public String hello()&#123;</span><br><span class="line">		return &quot;hello world!&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.启动Spring Boot应用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">@WebAppConfiguration</span><br><span class="line">public class HelloApplicationTests &#123;</span><br><span class="line"></span><br><span class="line">	private MockMvc mvc;</span><br><span class="line"></span><br><span class="line">	@Before</span><br><span class="line">	public void setUp() throws Exception&#123;</span><br><span class="line">		mvc = MockMvcBuilders.standaloneSetup(new HelloController()).build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Test</span><br><span class="line">	public void hello() throws Exception&#123;</span><br><span class="line">		mvc.perform(MockMvcRequestBuilders.get(&quot;/hello&quot;).accept(MediaType.APPLICATION_JSON))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(content().string(equalTo(&quot;Hello World!&quot;)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>@RunWith(SpringRunner.class)</code>:书中为<code>@RunWith(SpringJUnit4ClassRunner.class)</code>,引入Spring对JUnit4的支持<br/><br><code>@SpringBootTest</code>:书中为<code>@SpringApplicationConfiguration</code>,指定SpringBoot的启动类<br/><br><code>@WebAppConfiguration</code>:开启Web应用的配置,用于模拟ServletContext<br/><br><code>MockMvc</code>对象:用于模拟调用Controller的接口发起请求,在<code>@Test</code>定义的hello测试用例中,perform执行一次请求调用,accept用于执行接收的数据类型,andExpect用于判断接口返回的期望值<br/><br><code>@Before</code>:JUnit定义在测试用例@Test内容执行前预加载的内容,这里用来初始化对HelloController的模拟</p>
<h2 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h2><h3 id="SpringBoot默认配置文件位置"><a href="#SpringBoot默认配置文件位置" class="headerlink" title="SpringBoot默认配置文件位置"></a>SpringBoot默认配置文件位置</h3><p><code>src/main/resources/application.properties</code></p>
<h3 id="YAML配置格式"><a href="#YAML配置格式" class="headerlink" title="YAML配置格式"></a>YAML配置格式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">environments:</span><br><span class="line">	dev:</span><br><span class="line">		url: http://dev.bar.com</span><br><span class="line">		name: developer setup</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="自定义参数"><a href="#自定义参数" class="headerlink" title="自定义参数"></a>自定义参数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">book.name=SpringCloudApplication</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class Book&#123;</span><br><span class="line">	@Value(&quot;$&#123;book.name&#125;&quot;)</span><br><span class="line">	private String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="参数引用"><a href="#参数引用" class="headerlink" title="参数引用"></a>参数引用</h3><p>属性文件中的各个参数也可相互调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book.name=SpringCloud</span><br><span class="line">book.author=haha</span><br><span class="line">book.desc=$&#123;book.author&#125; is writing &amp;lt;$&#123;book.name&#125;&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="生成随机数"><a href="#生成随机数" class="headerlink" title="生成随机数"></a>生成随机数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$&#123;random&#125;的配置方式主要有以下几种</span><br><span class="line">#随机字符串</span><br><span class="line">blog.value=$&#123;random.value&#125;</span><br><span class="line">#随机int</span><br><span class="line">blog.number=$&#123;random.int&#125;</span><br><span class="line">#随机long</span><br><span class="line">blog.bignumber=$&#123;random.log&#125;</span><br><span class="line">#10以内的随机数</span><br><span class="line">blog.test1=$&#123;random.int(10)&#125;</span><br><span class="line">#10~20以内的随机数</span><br><span class="line">blog.test2=$&#123;random.int[10,20]&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h3><p>通过<code>java -jar xxx.jar --server.port=8888</code>可以将配置文件中server.port修改为8888</p>
<h3 id="多环境配置"><a href="#多环境配置" class="headerlink" title="多环境配置"></a>多环境配置</h3><p><code>spring.profiles.active</code>属性设置{profile}值<br/><br>例如:<code>spring.profiles.active=test</code>就会加载<code>application-test.properties</code></p>
<h3 id="加载顺序"><a href="#加载顺序" class="headerlink" title="加载顺序"></a>加载顺序</h3><blockquote>
</blockquote>
<p>1)在命令行传入的参数<br/>
2)SPRING_APPLICATION_JSON中的属性,SPRING_APPLICATION_JSON是以JSON格式<br/>
配置在系统环境变量中的内容<br/>
3)java:comp/env中的JNDI属性<br/>
4)Java的系统属性,可以通过System.getProperties()获得的内容<br/>
5)操作系统的环境变量<br/>
6)通过random.*配置的随机属性<br/>
7)jar包之外,不同环境对应的application-{profile}配置文件<br/>
8)jar包之内,不同环境对应的application-{profile}配置文件<br/>
9)jar包之外的application.properties或YAML<br/>
10)jar包之内的application.properties或YAML<br/>
11)@Configuration修改的类,通过@PropertySource注解定义的属性<br/>
12)应用默认属性,使用SpringApplication.setDefaultProperties定义的内容</p>


<p><code>以上数字越小优先级越高</code></p>
<h2 id="监控与管理"><a href="#监控与管理" class="headerlink" title="监控与管理"></a>监控与管理</h2><h3 id="初识actuator"><a href="#初识actuator" class="headerlink" title="初识actuator"></a>初识actuator</h3><p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-actuator&amp;lt;/artifactId&amp;gt;</span><br><span class="line">  &amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>刷新pom,此处若不刷新会报错<br/><br><img alt="actuator引入失败解决" src="https://img-blog.csdnimg.cn/20190316091018365.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>重启应用,控制台输出<br/><br><img alt="控制台输出" src="https://img-blog.csdnimg.cn/20190316091649997.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>访问<code>http://localhost:8080/health</code>可以实时获取应用的各项监控指标</p>
<h3 id="原生端点"><a href="#原生端点" class="headerlink" title="原生端点"></a>原生端点</h3><p>1.应用配置类:获取应用程序中加载的应用配置,环境变量,自动化配置报告等与SpringBoot应用密切相关的配置类信息<br/><br>2.度量指标类:获取应用程序运行过程中用于监控的度量指标,比如内存信息,线程池信息,HTTP请求统计等<br/><br>3.操作控制类:提供了对应用的关闭等操作类功能</p>
<h4 id="应用配置类"><a href="#应用配置类" class="headerlink" title="应用配置类"></a>应用配置类</h4><p>若要端点能够生效,需要在<code>application.properties</code>中加入<code>management.security.enabled=false</code><br/><br>否则会出现如下报错:status&#x3D;401<br/><br><img alt="未生效端点" src="https://img-blog.csdnimg.cn/20190316125418820.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br><code>/autoconfig</code>:该端点用来获取应用的自动化配置报告<br/><br><code>positiveMatches</code>中返回的是条件匹配成功的自动化配置	<br/><br><code>negativeMatches</code>中返回的是条件匹配不成功的自动化配置,可以查看具体没有生效的原因<br/><br><code>/beans</code>:该端点用来获取应用上下文中创建的所有bean<br/><br><code>/configprops</code>:该端点用于获取应用中配置的属性信息报告<br/><br><code>/env</code>:用来获取所有可用的环境属性报告,如环境变量,JVM属性,应用的配置属性,命令行中的参数,可以通过<kbd>@ConfigurationProperties</kbd>注解来引入到应用程序中使用<br/><br><code>/mappings</code>:该端点用来返回所有SpringMvc的控制器映射关系报告<br/><br><code>/info</code>:该端点用来返回一些应用自定义的信息<br/><br>比如在application.properties中通过info前缀设置属性:<code>info.app.name=spring-boot-hello</code></p>
<h4 id="度量指标类"><a href="#度量指标类" class="headerlink" title="度量指标类"></a>度量指标类</h4><p><code>/metrics</code>:该端点用来返回当前应用的各类重要度量指标,比如内存信息,线程信息,垃圾回收信息等<br/><br><code>/health</code>:该端点用于获取应用的各类健康指标信息.</p>
<p>|检测器|功能<br>|——<br>|DiskSpaceHealthIndicator|低磁盘空间检测<br>|DataSourceHealthIndicator|检测DataSource的连接是否可用<br>|MongoHealthIndicator|检测Mongo数据库是否可用<br>|RedisHealthIndicator|检测Redis服务器是否可用</p>
<p>对于没有自动化配置的检测器,需要自己来实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class RocketMQHealthIndicator implements HealthIndicator&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Health health() &#123;</span><br><span class="line">        int errorCode = check();</span><br><span class="line">        if(errorCode != 0)&#123;</span><br><span class="line">            return Health.down().withDetail(&quot;Error Code&quot;,errorCode).build();</span><br><span class="line">        &#125;</span><br><span class="line">        return Health.up().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private int check()&#123;</span><br><span class="line">        //对监控对象的检测操作</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>/dump</code>:该端点用于暴露程序运行时的线程信息<br/><br><code>/trace</code>:该端点用于返回基本的HTTP跟踪信息</p>
<h4 id="操作控制类"><a href="#操作控制类" class="headerlink" title="操作控制类"></a>操作控制类</h4><p><code>/shutdown</code>可以通过如下配置来开启,需要加入保护机制如定制化的actuator的端点路径或者整合Spring Security进行安全校验等<br/><br><code>endpoints.shutdown.enabled=true</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8-Spring%20Cloud%20Feign/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8-Spring%20Cloud%20Feign/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–声明式服务调用-Spring-Cloud-Feign"><a href="#原创：SPRING-CLOUD微服务实战笔记–声明式服务调用-Spring-Cloud-Feign" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–声明式服务调用:Spring Cloud Feign"></a>原创：SPRING CLOUD微服务实战笔记–声明式服务调用:Spring Cloud Feign</h1><h3 id="Spring-Cloud-Feign"><a href="#Spring-Cloud-Feign" class="headerlink" title="Spring Cloud Feign"></a>Spring Cloud Feign</h3><h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><p>通过Spring Cloud Feign提供的声明式服务绑定功能来实现对该服务接口的调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-feign&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@EnableFeignClients</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(&quot;hello-service&quot;)</span><br><span class="line">public interface HelloService &#123;</span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    String hello();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class ConsumerController &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    HelloService helloService;</span><br><span class="line">    @RequestMapping(value = &quot;/feign-consumer&quot; , method = RequestMethod.GET)</span><br><span class="line">    public String helloConsumer()&#123;</span><br><span class="line">        return helloService.hello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=feign-consumer</span><br><span class="line">server.port=9003</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试验证<br/><br>访问<code>http://localhost:9003/feign-consumer</code>,页面如下:<br/><br><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20190326213615567.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h1 id="参数绑定"><a href="#参数绑定" class="headerlink" title="参数绑定"></a>参数绑定</h1><p>第一步:改造服务提供方的服务<br/><br>服务提供方修改服务,增加接口定义,分别带有Request参数的请求,带有Header信息的请求,带有RequestBody的请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/hello1&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String hello(@RequestParam String name)&#123;</span><br><span class="line">        return &quot;Hello &quot; + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/hello2&quot;,method = RequestMethod.GET)</span><br><span class="line">    public User hello(@RequestHeader String name,@RequestHeader Integer age)&#123;</span><br><span class="line">        return new User(name,age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/hello3&quot; , method = RequestMethod.POST)</span><br><span class="line">    public String hello(@RequestBody User user)&#123;</span><br><span class="line">        return &quot;Hello &quot; + user.getName() + &quot;, &quot; + user.getAge();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>User对象定义如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class User &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private Integer age;</span><br><span class="line">    public User()&#123;&#125;</span><br><span class="line">    public User(String name,Integer age)&#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">//省略getter和setter方法</span><br><span class="line">    @Override</span><br><span class="line">    public String toString()&#123;</span><br><span class="line">        return &quot;name=&quot; + name + &quot;,age=&quot; + age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二步:改造服务消费端的请求绑定</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(&quot;hello-service&quot;)</span><br><span class="line">public interface HelloService &#123;</span><br><span class="line">        @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">        String hello();</span><br><span class="line">        @RequestMapping(value=&quot;/hello1&quot;,method = RequestMethod.GET)</span><br><span class="line">        String hello(@RequestParam(&quot;name&quot;) String name);</span><br><span class="line">        @RequestMapping(value = &quot;/hello2&quot;,method = RequestMethod.GET)</span><br><span class="line">        User hello(@RequestHeader(&quot;name&quot;) String name,@RequestHeader(&quot;age&quot;) Integer age);</span><br><span class="line">        @RequestMapping(value = &quot;/hello3&quot;,method = RequestMethod.POST)</span><br><span class="line">        String hello(@RequestBody User user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/feign-consumer2&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String helloConsumer2()&#123;</span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line">        sb.append(helloService.hello()).append(&quot;\n&quot;);</span><br><span class="line">        sb.append(helloService.hello(&quot;DIDI&quot;)).append(&quot;\n&quot;);</span><br><span class="line">        sb.append(helloService.hello(&quot;DIDI&quot;,30)).append(&quot;\n&quot;);</span><br><span class="line">        sb.append(helloService.hello(new User(&quot;DIDI&quot;,30))).append(&quot;\n&quot;);</span><br><span class="line">        return sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试验证<br/><br>访问<code>http://localhost:9003/feign-consumer2</code>,返回如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hello World! Hello DIDI name=DIDI,age=30 Hello DIDI, 30</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="继承特性"><a href="#继承特性" class="headerlink" title="继承特性"></a>继承特性</h1><p>通过Spring Cloud Feign的继承特性来实现REST接口定义的复用<br/><br>先新建一个Maven工程:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;modelVersion&amp;gt;4.0.0&amp;lt;/modelVersion&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;com.didispace&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;hello-service-api&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;packaging&amp;gt;jar&amp;lt;/packaging&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;0.0.1-SNAPSHOT&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;name&amp;gt;hello-service-api&amp;lt;/name&amp;gt;</span><br><span class="line">	&amp;lt;description&amp;gt;Demo project for Spring Boot&amp;lt;/description&amp;gt;</span><br><span class="line">	&amp;lt;parent&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-parent&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.3.7.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">		&amp;lt;relativePath&amp;gt;&amp;lt;/relativePath&amp;gt;</span><br><span class="line">	&amp;lt;/parent&amp;gt;</span><br><span class="line">	&amp;lt;properties&amp;gt;</span><br><span class="line">		&amp;lt;java.version&amp;gt;1.8&amp;lt;/java.version&amp;gt;</span><br><span class="line">	&amp;lt;/properties&amp;gt;</span><br><span class="line">	&amp;lt;dependencies&amp;gt;</span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/refactor&quot;)</span><br><span class="line">public interface HelloService &#123;</span><br><span class="line">    @RequestMapping(value = &quot;/hello4&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String hello(@RequestParam String name);</span><br><span class="line">    @RequestMapping(value = &quot;/hello5&quot;,method = RequestMethod.GET)</span><br><span class="line">    public User hello(@RequestHeader String name, @RequestHeader Integer age);</span><br><span class="line">    @RequestMapping(value = &quot;/hello6&quot; , method = RequestMethod.POST)</span><br><span class="line">    public String hello(@RequestBody User user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再修改服务提供方,对其进行重构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;com.didispace&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;hello-service-api&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;0.0.1-SNAPSHOT&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class RefactorHelloController implements HelloService &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public String hello(@RequestParam(&quot;name&quot;) String name) &#123;</span><br><span class="line">        return &quot;Hello &quot; + name;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public User hello(@RequestHeader(&quot;name&quot;) String name,@RequestHeader(&quot;age&quot;) Integer age) &#123;</span><br><span class="line">        return new User(name,age);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String hello(@RequestBody User user) &#123;</span><br><span class="line">        return &quot;Hello &quot; + user.getName() + &quot;, &quot; + user.getAge();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后修改服务消费者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;com.didispace&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;hello-service-api&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;0.0.1-SNAPSHOT&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(value = &quot;HELLO-SERVICE&quot;)</span><br><span class="line">public interface RefactorHelloService extends com.didispace.service.HelloService&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/feign-consumer3&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String helloConsumer3()&#123;</span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line">        sb.append(refactorHelloService.hello(&quot;MIMI&quot;)).append(&quot;\n&quot;);</span><br><span class="line">        sb.append(refactorHelloService.hello(&quot;MIMI&quot;,30)).append(&quot;\n&quot;);</span><br><span class="line">        sb.append(refactorHelloService.hello(new com.didispace.User.User(&quot;MIMI&quot;,20))).append(&quot;\n&quot;);</span><br><span class="line">        return sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>遇到的问题:<br/><br>将项目引入到maven私服库的时候,项目中调用接口不能识别,原来之前为了打包将pom中的编译插件换了,导致执行<code>mvn install</code>命令时编译有问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;build&amp;gt;</span><br><span class="line">	&amp;lt;plugins&amp;gt;</span><br><span class="line">		&amp;lt;plugin&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-maven-plugin&amp;lt;/artifactId&amp;gt;</span><br><span class="line">			&amp;lt;version&amp;gt;2.0.3.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">			&amp;lt;executions&amp;gt;</span><br><span class="line">				&amp;lt;execution&amp;gt;</span><br><span class="line">					&amp;lt;goals&amp;gt;</span><br><span class="line">						&amp;lt;goal&amp;gt;repackage&amp;lt;/goal&amp;gt;</span><br><span class="line">					&amp;lt;/goals&amp;gt;</span><br><span class="line">				&amp;lt;/execution&amp;gt;</span><br><span class="line">			&amp;lt;/executions&amp;gt;</span><br><span class="line">		&amp;lt;/plugin&amp;gt;</span><br><span class="line">	&amp;lt;/plugins&amp;gt;</span><br><span class="line">&amp;lt;/build&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将上面这段从pom中删除,重新执行<code>mvn install</code>后成功</p>
<h1 id="Ribbon配置"><a href="#Ribbon配置" class="headerlink" title="Ribbon配置"></a>Ribbon配置</h1><h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><p>通过使用ribbon.&#x3D;方式来设置ribbon的各项默认参数,比如修改默认的客户端调用超时时间:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ribbon.ConnectTimeout = 500</span><br><span class="line">ribbon.ReadTimeout=5000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="指定服务配置"><a href="#指定服务配置" class="headerlink" title="指定服务配置"></a>指定服务配置</h2><p>有时需要个性化配置,采用.ribbon.key&#x3D;value的格式进行设置<br/><br>使用@FeignClient(value &#x3D; “HELLO-SERVICE”)来创建Feign客户端的时候,同时也创建了一个名为HELLO-SERVICE的Ribbon客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HELLO-SERVICE.ribbon.ConnectTimeout=500</span><br><span class="line">HELLO-SERVICE.ribbon.ReadTimeout=2000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Hystrix配置"><a href="#Hystrix配置" class="headerlink" title="Hystrix配置"></a>Hystrix配置</h1><h2 id="全局配置-1"><a href="#全局配置-1" class="headerlink" title="全局配置"></a>全局配置</h2><p>Hystrix的全局配置采用默认配置前缀<code>hystrix.command.default</code>就可以设置,比如设置全局的超时时间:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=5000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过<code>feign.hystrix.enabled=false</code>来全局关闭Hystrix功能<br/><br>通过<code>feign.command.default.execution.timeout.enabled=false</code>来关闭熔断功能</p>
<h2 id="禁用Hystrix"><a href="#禁用Hystrix" class="headerlink" title="禁用Hystrix"></a>禁用Hystrix</h2><p>@Scope(“prototype”)注解为指定的客户端配置Feign.Builder实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class DisableHystrixConfiguration&#123;</span><br><span class="line">	@Bean</span><br><span class="line">	@Scope(&quot;prototype&quot;)</span><br><span class="line">	public Feign.Builder feignBuilder()&#123;</span><br><span class="line">		return Feign.builder();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(name=&quot;HELLO-SERVICE&quot;,configuration =DisableHystrixConfiguration.class)</span><br><span class="line">public interface HelloService&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h1><h2 id="请求压缩"><a href="#请求压缩" class="headerlink" title="请求压缩"></a>请求压缩</h2><p>SpringCloudFeign支持对请求与响应进行GZIP压缩,以减少通信过程中的性能损耗</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">feign.compression.request.enabled=true</span><br><span class="line">feign.compression.response.enabled=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时还可以进行更加细化的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">feign.compression.request.enabled=true;</span><br><span class="line">//指定压缩请求数据类型</span><br><span class="line">feign.comresstion.request.mime-types=text/xml,application/xml,application/json</span><br><span class="line">//请求压缩的大小下限,只有查过这个大小的请求才会对其进行压缩</span><br><span class="line">feign.compression.request.min-request-size=2048</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h2><p>可以在application.properties文件中使用<code>logging.level.&amp;lt;FeignClient&amp;gt;</code>的参数配置格式来开启指定Feign客户端的DEBUG日志,其中<code>&amp;lt;FeignClient&amp;gt;</code>为Feign客户端定义接口的完整路径,比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logging.level.com.didispace.web.HelloService=DEBUG</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时调整全局的日志级别,可以在应用主类中直接加入Logger.Level的Bean创建,具体如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@EnableFeignClients</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	Logger.Level feignLoggerLevel()&#123;</span><br><span class="line">		return Logger.Level.FULL;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于Feign的Logger级别主要有如下4类,可以根据实际需要进行调整使用</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1Spring%20Cloud%20Ribbon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1Spring%20Cloud%20Ribbon/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–客户端负载均衡Spring-Cloud-Ribbon"><a href="#原创：SPRING-CLOUD微服务实战笔记–客户端负载均衡Spring-Cloud-Ribbon" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–客户端负载均衡Spring Cloud Ribbon"></a>原创：SPRING CLOUD微服务实战笔记–客户端负载均衡Spring Cloud Ribbon</h1><h3 id="Spring-Cloud-Ribbon"><a href="#Spring-Cloud-Ribbon" class="headerlink" title="Spring Cloud Ribbon"></a>Spring Cloud Ribbon</h3><h1 id="客户端负载均衡"><a href="#客户端负载均衡" class="headerlink" title="客户端负载均衡"></a>客户端负载均衡</h1><p>负载均衡是对系统的高可用,网络压力的缓解和处理能力扩容的重要手段之一<br/><br>通常说的负载均衡都是指服务端的负载均衡,分为硬件负载均衡和软件负载均衡<br/><br>硬件负载均衡主要通过在服务器节点之间安装专门用于负载均衡的设备,如F5等<br/><br>软件负载均衡主要通过在服务器上安装一些具有均衡负载功能或模块的软件来完成请求分发工作,比如Nginx等<br/><br>客户端使用负载均衡分成两步:<br/><br>1.服务提供者只需要启动多个服务实例并注册到一个注册中心或者多个相关联的服务注册中心<br/><br>2.服务消费者直接通过调用被@LoadBalanced注解修饰过的RestTemplate来实现面向服务的接口调用</p>
<h2 id="RestTemplate详解"><a href="#RestTemplate详解" class="headerlink" title="RestTemplate详解"></a>RestTemplate详解</h2><h3 id="GET请求"><a href="#GET请求" class="headerlink" title="GET请求"></a>GET请求</h3><p>1.getForEntity函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate restTemplate = new RestTemplate();</span><br><span class="line">ResponseEntity&amp;lt;String&amp;gt; responseEntity = restTemplate.getForEntity(&quot;http://USER-SERVICE/user?name=&#123;1&#125;&quot;,String.class,&quot;didi&quot;);</span><br><span class="line">String body = responseEntity.getBody();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三种重载实现:其中url为请求的地址,responseType为请求相应体body的包装类型,urlVariables为url中的参数绑定,如上面就是拼接的url<code>http://USER-SERVICE/user?name=didi</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getForEntity(String url,Class responseType,Object... urlVariables);</span><br><span class="line">getForEntity(String url,Class responseType,Map urlVariables);</span><br><span class="line">getForEntity(URI url,Class responseType);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.getForObject函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate restTemplate = new RestTemplate();</span><br><span class="line">String result = restTemplate.getForObject(uri,String.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三种重载实现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getForObject(String url,Class responseType,Object... urlVariables);</span><br><span class="line">getForObject(String url,Class responseType,Map urlVariables);</span><br><span class="line">getForObject(URI url,Class responseType);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h3><p>1.postForEntity函数<br/><br>其实从get和post的区别就可以想象出postForEntity的用法:<br/><br>1)有个类来封装要传送的信息<br/><br>2)请求地址url中不会出现请求的参数<br/><br>3)封装类被作为参数放在postForEntity方法中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate restTemplate = new RestTemplate();</span><br><span class="line">User user= new User(&quot;didi&quot;,30);</span><br><span class="line">ResponseEntity&amp;lt;String&amp;gt; responseEntity = restTemplate.postForEntity(&quot;http://USER-SERVICE/user&quot;,user,String.class);</span><br><span class="line">String body = responseEntity.getBody();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三种重载实现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">postForEntity(String url,Object request,Class responseType,Object... urlVariables);</span><br><span class="line">postForEntity(String url,Object request,Class responseType,Map urlVariables);</span><br><span class="line">postForEntity(URI url,Object request,Class responseType);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.postForObject函数<br/><br>postForObject简化了postForEntity的处理:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate restTemplate = new RestTemplate();</span><br><span class="line">User user = new User(&quot;didi&quot;,20);</span><br><span class="line">String postResult = restTemplate.postForObject(&quot;http://USER-SERVICE/user&quot;,user,String.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三种重载实现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">postForObject(String url,Object request,Class responseType,Object... urlVariables);</span><br><span class="line">postForObject(String url,Object request,Class responseType,Map urlVariables);</span><br><span class="line">postForObject(URI url,Object request,Class responseType);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.postForLocation函数<br/><br>以post请求提交资源,并返回新资源的URI</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User user = new User(&quot;didi&quot;,40);</span><br><span class="line">URI responseURI = restTemplate.postForLocation(&quot;http://USER-SERVICE/user&quot;,user);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三种重载实现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">postForLocation(String url,Object request,Object... urlVariables);</span><br><span class="line">postForLocation(String url,Object request,Map urlVariables);</span><br><span class="line">postForLocation(URI url,Object request);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="PUT请求"><a href="#PUT请求" class="headerlink" title="PUT请求"></a>PUT请求</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate restTemplate  = new RestTemplate();</span><br><span class="line">Long id = 10001L;</span><br><span class="line">User user = new User(&quot;didi&quot;,40);</span><br><span class="line">restTemplate.put(&quot;http://USER-SERVICE/user/&#123;1&#125;&quot;,user,id);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>put函数也实现了三种不同的重载方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">put(String url,Object request,Object... urlVariables);</span><br><span class="line">put(String url,Object request,Map urlVariables);</span><br><span class="line">put(URI url,Object request);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="DELETE请求"><a href="#DELETE请求" class="headerlink" title="DELETE请求"></a>DELETE请求</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RestTemplate restTemplate = new RestTemplate();</span><br><span class="line">Long id = 10001L;</span><br><span class="line">restTemplate.delete(&quot;http://USER-SERVICE/user/&#123;1&#125;&quot;,id);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>delete函数三种不同的重载方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">delete(String url,Object... urlVariables)</span><br><span class="line">delete(String url,Map urlVariables)</span><br><span class="line">delete(URI url)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h2><p>在引入Spring Cloud Ribbon的依赖以后,就能够自动化构建下面这些接口的实现:</p>
<p>|接口<th align="center">默认实现</th>|作用<br>|——<br>|IClientConfig<td align="center">com.netflix.client.config.DefaultClientConfigImpl</td>|Ribbon的客户端配置<br>|IRule<td align="center">com.netflix.loadbalancer.ZoneAvoidanceRule</td>|Ribbon的负载均衡策略,能够在多区域环境下选出最佳区域的实例进行访问<br>|IPing<td align="center">com.netflix.loadbalancer.NoOpPing</td>|Ribbon的实例检查策略,默认所有服务实例都是可用的<br>|ServerList<td align="center">com.netflix.loadbalancer.ConfigurationBasedServerList</td>|服务实例清单的维护机制<br>|ServerListFilter<td align="center">org.springframework.cloud.netflix.ribbon.ZonePreferenceServerListFilter</td>|服务实例清单过滤机制,优先过滤出于请求调用方处于同区域的服务实例<br>|ILoadBalancer<td align="center">com.netflix.loadbalancer.ZoneAwareLoadBalancer</td>|负载均衡器,具备了区域感知的能力</p>
<p>覆盖默认的配置,实现个性化需求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyRibbonConfiguration&#123;</span><br><span class="line">	@Bean</span><br><span class="line">	public IPing ribbonPing(IClientConfig config)&#123;</span><br><span class="line">		return new PingUrl();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h3><p>对于Ribbon的参数配置通常有两种方式,全局配置以及指定客户端配置</p>
<h2 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h2><p>Eureka和Zookeeper的区别<br/><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vincent928/p/10084176.html">https://www.cnblogs.com/vincent928/p/10084176.html</a><br/><br>Cap定理:<br/><br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/07/cap.html">http://www.ruanyifeng.com/blog/2018/07/cap.html</a><br/><br>为了增加服务调用的时候的容错,需要加入一些重试机制,在配置文件中加入内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.loadbalancer.retry.enabled=true</span><br><span class="line">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=1000</span><br><span class="line">&amp;lt;服务名&amp;gt;.ribbon.ConnectTimeOut=250</span><br><span class="line">&amp;lt;服务名&amp;gt;.ribbon.ReadTimeOut=1000</span><br><span class="line">&amp;lt;服务名&amp;gt;.ribbon.OkToRetryOnAllOperations=true</span><br><span class="line">&amp;lt;服务名&amp;gt;.ribbon.MaxAutoRetriesNextServer=2</span><br><span class="line">&amp;lt;服务名&amp;gt;.ribbon.MaxAutoRetries=1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-Spring%20Cloud%20Eureka(%E4%B8%80)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-Spring%20Cloud%20Eureka(%E4%B8%80)/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–服务治理-Spring-Cloud-Eureka-一"><a href="#原创：SPRING-CLOUD微服务实战笔记–服务治理-Spring-Cloud-Eureka-一" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–服务治理:Spring Cloud Eureka(一)"></a>原创：SPRING CLOUD微服务实战笔记–服务治理:Spring Cloud Eureka(一)</h1><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><h1 id="服务治理"><a href="#服务治理" class="headerlink" title="服务治理"></a>服务治理</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">服务治理可以说是微服务架构中最为核心和基础的模块,主要用来实现各个微服务实例的自动化注册与发现</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Netflix-Eureka"><a href="#Netflix-Eureka" class="headerlink" title="Netflix Eureka"></a>Netflix Eureka</h2><p>Eureka服务端:<br/><br>1.分片故障转入自我保护模式,并继续提供服务<br/><br>2.分片恢复,同步分片<br/><br>Eureka客户端:<br/><br>1.向注册中心注册自身服务,并周期性发送心跳报文来更新服务租约<br/><br>2.从服务端查询注册服务信息并缓存到本地并周期性地刷新服务状态</p>
<h2 id="搭建服务注册中心"><a href="#搭建服务注册中心" class="headerlink" title="搭建服务注册中心"></a>搭建服务注册中心</h2><p>pom.xml加入以下依赖:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-cloud-starter-eureka-server&amp;lt;/artifactId&amp;gt;</span><br><span class="line">			&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用注解<code>@EnableEurekaServer</code>启动一个服务注册中心<br/><br>防止默认设置下,该服务注册中心会将自己作为客户端来尝试注册自己,需要禁用客户端注册行为,在application.properties中加入:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server.port=1111</span><br><span class="line">eureka.instance.hostname=localhost</span><br><span class="line">#不向注册中心注册自己</span><br><span class="line">eureka.client.register-with-eureka=false</span><br><span class="line">#不需要去检索服务</span><br><span class="line">eureka.client.fetch-registry=false</span><br><span class="line">eureka.client.service-url.defaultZone=http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问<code>http://localhost:1111/</code>,返回页面如下<br/><br><img alt="SpringEureka" src="https://img-blog.csdnimg.cn/20190316211331707.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>可以看到Instances currently registered with Eureka中没有服务,接下来任务就是注册服务<br/><br>总结三步就是:<br/><br>1.pom.xml中加入<code>spring-cloud-starter-eureka-server</code><br/><br>2.在启动类上加上<code>@EnableEurekaServer</code><br/><br>3.配置application.properties</p>
<blockquote>
</blockquote>
<p>#不向注册中心注册自己<br/>
eureka.client.register-with-eureka=false<br/>
#不需要去检索服务<br/>
eureka.client.fetch-registry=false</p>


<h2 id="注册服务提供者"><a href="#注册服务提供者" class="headerlink" title="注册服务提供者"></a>注册服务提供者</h2><p>注册服务提供者分为四步:<br/><br>1.pom.xml中加入<code>spring-cloud-starter-eureka</code><br/><br>2.改造请求处理接口,通过注入<code>DiscoveryClient</code>对象,在日志中打印出服务的相关内容<br/><br>3.在启动类上加入<code>@EnableEurekaClient</code>注解,激活Eureka中的<code>DiscoveryClient</code>实现<br/><br>4.在<code>application.properties</code>中加入<code>spring.application.name</code>作为服务名,再用<code>eureka.client.serviceUrl.defaultZone</code>属性来指定服务注册中心的地址<br/><br>服务提供方服务注册成功如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[nfoReplicator-0] com.netflix.discovery.DiscoveryClient    : DiscoveryClient_HELLO-SERVICE/192.168.1.105:hello-service - registration status: 204</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>服务注册中的控制台显示如下,则服务被注册成功:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">main] o.s.c.n.e.s.EurekaServiceRegistry        : Registering application hello-service with eureka with status UP</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登录Eureka的信息面板可以看到,注册的服务<br/><br><img alt="服务注册信息" src="https://img-blog.csdnimg.cn/20190316225215195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h2 id="高可用注册中心"><a href="#高可用注册中心" class="headerlink" title="高可用注册中心"></a>高可用注册中心</h2><p>1.在之前的基础上再复制一个注册中心项目出来,创建application-peer1.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=eureka-server</span><br><span class="line">server.port=1111</span><br><span class="line">eureka.instance.hostname=peer1</span><br><span class="line">eureka.client.service-url.defaultZone=http://peer2:1112/eureka/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.在原有的注册中心上创建application-peer2.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=eureka-server</span><br><span class="line">server.port=1112</span><br><span class="line">eureka.instance.hostname=peer2</span><br><span class="line">eureka.client.service-url.defaultZone=http://peer1:1111/eureka/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.在&#x2F;etc&#x2F;hosts文件中添加对peer1和peer2的转换,或者直接将properties中写出地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1  peer1</span><br><span class="line">127.0.0.1  peer2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.启动项目<br/><br>根据之前的学习,可以知道<br/><br>在<code>application.properties</code>中加入<code>spring.profiles.active=peer1</code>,就可以启动<code>application-peer1.properties</code><br/><br>在<code>application.properties</code>中加入<code>spring.profiles.active=peer2</code>,就可以启动<code>application-peer2.properties</code><br/><br>直接运行主类,就可以不用打jar包了<br/><br>5.服务提供方启动<br/><br>使用之前单节点模块的服务提供方,修改application.properties</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=hello-service</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka/,http://localhost:1112/eureka/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问<code>localhost:1112</code>连接效果如下:<br/><br><img alt="localhost:1112" src="https://img-blog.csdnimg.cn/20190317103616478.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>访问<code>localhost:1111</code>连接效果如下:<br/><br><img alt="localhost:1111" src="https://img-blog.csdnimg.cn/20190317103746800.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>6.遇到的问题:<br/><br>1)启动顺序<br/><br>先启动服务提供方会报连接超时,原因就是服务注册中心没有启动,所以应该先启动服务注册中心</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">com.sun.jersey.api.client.ClientHandlerException: java.net.ConnectException: Connection refused (Connection refused)</span><br><span class="line">	at com.sun.jersey.client.apache4.ApacheHttpClient4Handler.handle(ApacheHttpClient4Handler.java:187) ~[jersey-apache-client4-1.19.1.jar:1.19.1]</span><br><span class="line">	at com.sun.jersey.api.client.filter.GZIPContentEncodingFilter.handle(GZIPContentEncodingFilter.java:123) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line">	at com.netflix.discovery.EurekaIdentityHeaderFilter.handle(EurekaIdentityHeaderFilter.java:27) ~[eureka-client-1.7.2.jar:1.7.2]</span><br><span class="line">	at com.sun.jersey.api.client.Client.handle(Client.java:652) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line">	at com.sun.jersey.api.client.WebResource.handle(WebResource.java:682) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line">	at com.sun.jersey.api.client.WebResource.access$200(WebResource.java:74) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line">	at com.sun.jersey.api.client.WebResource$Builder.get(WebResource.java:509) ~[jersey-client-1.19.1.jar:1.19.1]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2)注册中心显示unavailable-replicas<br/><br><img alt="unavailable-replicas" src="https://img-blog.csdnimg.cn/20190317103918929.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>修改两个注册服务中心的<code>application.properties</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.register-with-eureka=true</span><br><span class="line">eureka.client.fetch-registry=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再次访问<code>localhost:1111</code>,显示如下<br/><br><img alt="localhost:1111" src="https://img-blog.csdnimg.cn/20190317104221568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>再次访问<code>localhost:1112</code>,显示如下:<br/><br><img alt="localhost:1112" src="https://img-blog.csdnimg.cn/20190317104453131.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>这样断开peer1,则服务同时也向peer2注册,所以在peer2上依然可以访问服务,从而实现了服务注册中心的高可用</p>
<h2 id="服务发现与消费"><a href="#服务发现与消费" class="headerlink" title="服务发现与消费"></a>服务发现与消费</h2><p>1.为了实验Ribbon客户端负载均衡功能,需要先启动两个不同端口的服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -jar  xxx.jar  --server.port=8081</span><br><span class="line">java -jar  xxx.jar  --server.port=8082</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.创建一个工程来实现服务消费者,可以直接复制一个服务提供方的工程来进行修改<br/><br>在pom.xml中加入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-ribbon&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.创建主类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class DemoApplication &#123;</span><br><span class="line">	@Bean</span><br><span class="line">	@LoadBalanced</span><br><span class="line">	RestTemplate restTemplate()&#123;</span><br><span class="line">		return new RestTemplate();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.修改客户端工程的<code>application.properties</code>,配置上Eureka服务注册中心的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=ribbon-consumer</span><br><span class="line">server.port=9000</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka/,http://localhost:1112/eureka/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.配置好后,启动应用,可以看到ribbon-consumer的服务<br/><br><img alt="ribbon服务消费者" src="https://img-blog.csdnimg.cn/2019031713460374.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>Ribbon的负载均衡是通过客户端中配置的ribbonServerList服务端列表去轮询访问来实现的<br/><br>Ribbon负载均衡原理:当Ribbon与Eureka联合使用时,Ribbon的服务实例清单<code>RibbonServerList</code>会被<code>DiscoveryEnableNIWSServerList</code>重写,扩展成从Eureka注册中心中获取服务端列表.另外也会用<code>NIWSDiscoveryPing</code>来取代<code>IPing</code>,它将职责委托给Eureka来确定服务端是否已经启动.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-Spring%20Cloud%20Eureka(%E4%BA%8C)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/1.webp">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86-Spring%20Cloud%20Eureka(%E4%BA%8C)/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–服务治理-Spring-Cloud-Eureka-二"><a href="#原创：SPRING-CLOUD微服务实战笔记–服务治理-Spring-Cloud-Eureka-二" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–服务治理:Spring Cloud Eureka(二)"></a>原创：SPRING CLOUD微服务实战笔记–服务治理:Spring Cloud Eureka(二)</h1><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><h1 id="Spring-Cloud-Eureka"><a href="#Spring-Cloud-Eureka" class="headerlink" title="Spring Cloud Eureka"></a>Spring Cloud Eureka</h1><h2 id="Eureka详解"><a href="#Eureka详解" class="headerlink" title="Eureka详解"></a>Eureka详解</h2><h3 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h3><p>1.服务注册中心:Eureka提供的服务端,提供服务的注册与发现<br/><br>2.服务提供者:提供服务的应用,将服务注册到Eureka<br/><br>3.服务消费者:从服务注册中心获取到服务列表<br/><br>很多时候,客户端既是服务提供者,也是服务消费者<br/><br>从之前的例子中也可以看出,pom.xml中依赖都是<code>spring-cloud-starter-eureka</code><br/><br>如果在服务提供者这一方也用Ribbon,那么就像服务消费者一样了</p>
<h3 id="服务治理机制"><a href="#服务治理机制" class="headerlink" title="服务治理机制"></a>服务治理机制</h3><h4 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h4><p>Eureka Server将元数据信息存储在一个双层结构Map中,第一层的key为服务名,第二层的key为具体服务的实例名<br/><br><img alt="双层Map" src="https://img-blog.csdnimg.cn/2019031715351519.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h5 id="服务同步"><a href="#服务同步" class="headerlink" title="服务同步"></a>服务同步</h5><p>服务提供者提供发送注册请求会被转发到其他相连的注册中心,从而实现注册中心之间的服务同步.通过服务同步,服务信息可以从服务注册中心的任意一台都能够获取到.<br/><br>对于服务提供者,注册一台就相当于注册所有台<br/><br>对于服务消费者,请求一台就相当于请求所有台</p>
<h5 id="服务续约"><a href="#服务续约" class="headerlink" title="服务续约"></a>服务续约</h5><p>服务提供者通过心跳报文来通知Eureka Server,以免被排除</p>
<h4 id="服务消费者"><a href="#服务消费者" class="headerlink" title="服务消费者"></a>服务消费者</h4><h5 id="获取服务"><a href="#获取服务" class="headerlink" title="获取服务"></a>获取服务</h5><p>1.获取服务是服务消费者的基础,所以需要确定的参数<br/><br><code>eureka.client.fetch-registry=true</code>,且默认为true<br/><br>2.服务缓存清单<code>30</code>秒更新一次</p>
<h5 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h5><p>Ribbon默认会采用轮询的方式进行调用,从而实现客户端的负载均衡</p>
<h5 id="服务下线"><a href="#服务下线" class="headerlink" title="服务下线"></a>服务下线</h5><p>服务客户端会在下线时发送REST请求给Eureka Server,服务端接收到请求之后,会将该服务状态置为下线(<code>Down</code>)</p>
<h4 id="服务注册中心"><a href="#服务注册中心" class="headerlink" title="服务注册中心"></a>服务注册中心</h4><h5 id="失效剔除"><a href="#失效剔除" class="headerlink" title="失效剔除"></a>失效剔除</h5><p>Eureka Server在启动时会创建定时任务,默认每隔<code>60</code>秒将当前清单中超时(默认<code>90</code>秒)没有续约的服务剔除</p>
<h5 id="自我保护"><a href="#自我保护" class="headerlink" title="自我保护"></a>自我保护</h5><p>自我保护标准:心跳失败比例是否低于85%<br/><br>应用场景:当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障）<br/><br>应用目的:在出现故障以后,Eureka Server将注册信息保护起来,不再删除注册信息,在故障恢复后,Eureka Server会自动退出自我保护模式<br/><br>这个自我保护在本地进行开发的时候,其实并不是那么需要,可以通过参数关闭<br/><br><code>eureka.server.enable-self-preservation=false</code>,这样就可以及时剔除无效的服务</p>
<h2 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h2><p>Eureka客户端的配置对象存在于所有Eureka服务治理体系下的应用体系中<br/><br>Eureka客户端的配置主要分为两个方面:<br/><br>1.服务注册相关的配置信息,包括服务注册中心的地址,服务获取的间隔时间等<br/><br>2.服务实例相关的配置信息,包括服务实例的名称,IP地址,端口号等</p>
<h3 id="服务实例类配置"><a href="#服务实例类配置" class="headerlink" title="服务实例类配置"></a>服务实例类配置</h3><p>1.元数据:Eureka客户端在向服务注册中心发送注册请求时,用来描述自身服务信息的对象,其中包含了一些标准化数据,比如服务名称,实例名称,实例IP,实例端口等<br/><br>2.实例名配置<br/><br><code>eureka.instance.instanceId=$&#123;spring.application.name&#125;:$&#123;random.int&#125;</code><br/><br>通过上面的配置,利用应用名加上随机数的方式来区分不同的实例,从而实现在同一主机上,不指定端口就能轻松启动多个实例的效果<br/><br>3.健康检测<br/><br>为了避免客户端进程能够正常运作,但是客户端应用不能够提供服务的情况发生,通过默认的心跳检测方式,不是很合理<br/><br>正确的检测如下:</p>
<h2 id="跨平台支持"><a href="#跨平台支持" class="headerlink" title="跨平台支持"></a>跨平台支持</h2><p>Eureka的通信机制使用了HTTP 的REST接口实现,由于HTTP的平台无关性,使得其下的微服务应用并不限于使用JAVA来开发</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
