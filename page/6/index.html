<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lengendofdong.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://lengendofdong.github.io/page/6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://lengendofdong.github.io/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">135</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99%E4%BF%9D%E6%8A%A4-Spring%20Cloud%20Hystrix(%E4%BA%8C)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99%E4%BF%9D%E6%8A%A4-Spring%20Cloud%20Hystrix(%E4%BA%8C)/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–服务容错保护-Spring-Cloud-Hystrix-二"><a href="#原创：SPRING-CLOUD微服务实战笔记–服务容错保护-Spring-Cloud-Hystrix-二" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–服务容错保护:Spring Cloud Hystrix(二)"></a>原创：SPRING CLOUD微服务实战笔记–服务容错保护:Spring Cloud Hystrix(二)</h1><h3 id="Spring-Cloud-Hystrix"><a href="#Spring-Cloud-Hystrix" class="headerlink" title="Spring Cloud Hystrix"></a>Spring Cloud Hystrix</h3><h1 id="属性详解"><a href="#属性详解" class="headerlink" title="属性详解"></a>属性详解</h1><p>四种不同优先级别的配置(优先级由低到高)</p>
<h2 id="Command属性"><a href="#Command属性" class="headerlink" title="Command属性"></a>Command属性</h2><p>主要有5种不同类型的属性配置:</p>
<h3 id="execution配置"><a href="#execution配置" class="headerlink" title="execution配置"></a>execution配置</h3><p>execution配置控制的是<code>HystrixCommand.run()</code>的执行</p>
<h3 id="fallback配置"><a href="#fallback配置" class="headerlink" title="fallback配置"></a>fallback配置</h3><p>这些属性用来控制<code>HystrixCommand.getFallback()</code>的执行.这些属性同时适用于线程池的信号量的隔离策略</p>
<h3 id="circuitBreaker配置"><a href="#circuitBreaker配置" class="headerlink" title="circuitBreaker配置"></a>circuitBreaker配置</h3><p>下面这些是断路器的属性配置,用来控制<code>HystrixCircuitBreaker</code>的行为</p>
<h3 id="metrics设置"><a href="#metrics设置" class="headerlink" title="metrics设置"></a>metrics设置</h3><p>下面的属性均与<code>HystrixCommand</code>和<code>HystrixObservableCommand</code>执行中捕获的指标信息有关.</p>
<h3 id="requestContext配置"><a href="#requestContext配置" class="headerlink" title="requestContext配置"></a>requestContext配置</h3><p>下面这些属性涉及<code>HystrixCommand</code>使用的<code>HystrixRequestContext</code>的配置</p>
<h3 id="collapser属性"><a href="#collapser属性" class="headerlink" title="collapser属性"></a>collapser属性</h3><p>该属性除了在代码中用set和配置文件配置之外,也可使用注解进行配置.可使用<code>@HystrixCollapser</code>中的<code>collapserProperties</code>属性来设置,比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@HystrixCollapser(batchMethod = &quot;batch&quot;,collapserProperties = &#123;@HystrixProperty(name = &quot;timerDelayInMilliseconds&quot;,value = &quot;20&quot;)&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面这些属性用来控制命令合并相关的行为</p>
<h3 id="threadPool属性"><a href="#threadPool属性" class="headerlink" title="threadPool属性"></a>threadPool属性</h3><p>该属性除了在代码中用set和属性文件配置之外,还可使用注解进行设置.可使用<code>@HystrixCommand</code>中的<code>threadPoolProperties</code>属性来设置,比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@HystrixCommand(fallbackMethod=&quot;helloFallback&quot; , commandKey=&quot;helloKey&quot;,threadPoolProperties=&#123;@HystrixProperty(name=&quot;coreSize&quot;,value=&quot;20&quot;)&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面这些属性用来控制Hystrix命令所属线程池的配置</p>
<h1 id="Hystrix仪表盘"><a href="#Hystrix仪表盘" class="headerlink" title="Hystrix仪表盘"></a>Hystrix仪表盘</h1><p>构建一个Hystrix Dashboard,需要四步:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-hystrix-dashboard&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=hystrix-dashboard</span><br><span class="line">server.port=2001</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动应用,看到如下页面:<br/><br><img alt="Hystrix Dashboard" src="https://img-blog.csdnimg.cn/20190325152310174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>首页的两个参数,Delay和Title:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-hystrix&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-boot-starter-actuator&amp;lt;/artifactId&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二步,在服务消费方的主类中使用@EnableCircuitBreaker注解,开启断路器功能<br/><br>重启服务消费方,在Hystrix Dashboard的首页输入<a target="_blank" rel="noopener" href="http://localhost:9000/hystrix.stream,%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A6%82%E4%B8%8B%E9%A1%B5%E9%9D%A2">http://localhost:9000/hystrix.stream,可以看到如下页面</a><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20190325170829377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h1 id="Turbine-集群监控"><a href="#Turbine-集群监控" class="headerlink" title="Turbine 集群监控"></a>Turbine 集群监控</h1><h2 id="构建监控聚合服务"><a href="#构建监控聚合服务" class="headerlink" title="构建监控聚合服务"></a>构建监控聚合服务</h2><p>1.引入Turbine来聚合RIBBON-CONSUMER服务的监控信息,并输出给Hystrix Dashboard来进行展示,具体步骤如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;parent&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-parent&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;Brixton.SR5&amp;lt;/version&amp;gt;</span><br><span class="line">		&amp;lt;relativePath/&amp;gt; &amp;lt;!-- lookup parent from repository --&amp;gt;</span><br><span class="line">	&amp;lt;/parent&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;com.didispace&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;hello&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;0.0.1-SNAPSHOT&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;name&amp;gt;hello&amp;lt;/name&amp;gt;</span><br><span class="line">	&amp;lt;description&amp;gt;Demo project for Spring Boot&amp;lt;/description&amp;gt;</span><br><span class="line"></span><br><span class="line">	&amp;lt;properties&amp;gt;</span><br><span class="line">		&amp;lt;java.version&amp;gt;1.8&amp;lt;/java.version&amp;gt;</span><br><span class="line">	&amp;lt;/properties&amp;gt;</span><br><span class="line"></span><br><span class="line">	&amp;lt;dependencies&amp;gt;</span><br><span class="line">		&amp;lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-turbine --&amp;gt;</span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-cloud-starter-turbine&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-starter-actuator&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-starter-test&amp;lt;/artifactId&amp;gt;</span><br><span class="line">			&amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableTurbine</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=turbine</span><br><span class="line"></span><br><span class="line">server.port=8989</span><br><span class="line">management.port=8990</span><br><span class="line"></span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka/</span><br><span class="line"></span><br><span class="line">turbine.app-config=RIBBON-CONSUMER</span><br><span class="line">turbine.cluster-name-expression=&quot;default&quot;</span><br><span class="line">turbine.combine-host-port=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>turbine.app-config:该参数指定了需要收集监控信息的服务名<br/><br>turbine.cluster-name-expression:该参数指定了集群名称为default<br/><br>turbine.combine-host-port:该参数设置为true,可以让同一主机上的服务通过主机名和端口号的组合来进行区分<br/><br>启动eureka-server&#x2F;HELLO-SERVER&#x2F;RIBBON-CONSUMER&#x2F;Turbine&#x2F;Hystrix Dashboard,页面如下:<br/><br><img alt="Turbine" src="https://img-blog.csdnimg.cn/2019032518435437.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h2 id="与消息代理结合"><a href="#与消息代理结合" class="headerlink" title="与消息代理结合"></a>与消息代理结合</h2><p>实现基于消息代理的Turbine聚合服务<br/><br>1)创建一个标准的Spring Boot工程,命名为turbine-amqp<br/><br>2)编辑pom.xml,导入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;parent&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-parent&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;Brixton.SR5&amp;lt;/version&amp;gt;</span><br><span class="line">		&amp;lt;relativePath/&amp;gt; &amp;lt;!-- lookup parent from repository --&amp;gt;</span><br><span class="line">	&amp;lt;/parent&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;com.didispace&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;hello&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;0.0.1-SNAPSHOT&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;name&amp;gt;hello&amp;lt;/name&amp;gt;</span><br><span class="line">	&amp;lt;description&amp;gt;Demo project for Spring Boot&amp;lt;/description&amp;gt;</span><br><span class="line"></span><br><span class="line">	&amp;lt;properties&amp;gt;</span><br><span class="line">		&amp;lt;java.version&amp;gt;1.8&amp;lt;/java.version&amp;gt;</span><br><span class="line">	&amp;lt;/properties&amp;gt;</span><br><span class="line"></span><br><span class="line">	&amp;lt;dependencies&amp;gt;</span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-cloud-starter-turbine-amqp&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-starter-actuator&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br><span class="line">		&amp;lt;dependency&amp;gt;</span><br><span class="line">			&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">			&amp;lt;artifactId&amp;gt;spring-boot-starter-test&amp;lt;/artifactId&amp;gt;</span><br><span class="line">			&amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;</span><br><span class="line">		&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3)在应用类中使用@EnableTurbineStream注解来启用Turbine Stream的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@EnableTurbineStream</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4)配置application.properties文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=turbine</span><br><span class="line">server.port=8989</span><br><span class="line">management.port=8990</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5)服务消费者也要进行更改pom.xml,使其监控信息能够输出到RabbitMQ上.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-netflix-hystrix-amqp&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-Spring%20Cloud%20Config/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-Spring%20Cloud%20Config/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–分布式配置中心-Spring-Cloud-Config"><a href="#原创：SPRING-CLOUD微服务实战笔记–分布式配置中心-Spring-Cloud-Config" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–分布式配置中心:Spring Cloud Config"></a>原创：SPRING CLOUD微服务实战笔记–分布式配置中心:Spring Cloud Config</h1><h3 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h3><h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><h2 id="构建配置中心"><a href="#构建配置中心" class="headerlink" title="构建配置中心"></a>构建配置中心</h2><p>通过SpringCloudConfig构建一个分布式配置中心,分成三步:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-config-server&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@EnableConfigServer</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=config-server</span><br><span class="line">server.port=7001</span><br><span class="line">spring.cloud.config.server.git.uri=http://git.oschina.net/dongarea/SpringCloud-Learning/</span><br><span class="line">spring.cloud.config.server.git.search-paths=/spring_cloud_in_action</span><br><span class="line">spring.cloud.config.server.git.username=username</span><br><span class="line">spring.cloud.config.server.git.password=password</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>spring.cloud.config.server.git.uri:配置Git仓库位置<br/><br>spring.cloud.config.server.git.searchPaths:配置仓库路径下的相对搜索位置,可以配置多个<br/><br>spring.cloud.config.server.git.username:访问Git仓库的用户名<br/><br>spring.cloud.config.server.git.password:访问Git仓库的密码</p>
<h2 id="配置规则详解"><a href="#配置规则详解" class="headerlink" title="配置规则详解"></a>配置规则详解</h2><p>在码云上建立自己的git仓库<code>http://git.oschina.net/dongarea/SpringCloud-Learning/</code>,新建四个配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dongarea.properties</span><br><span class="line">dongarea-dev.properties</span><br><span class="line">dongarea-test.properties</span><br><span class="line">dongarea-prod.properties</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>并为每个配置文件设置不同的值,如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from=git-default-1.0</span><br><span class="line">from=git-dev-1.0</span><br><span class="line">from=git-test-1.0</span><br><span class="line">from=git-prod-1.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时创建一个config-label-test分支,并将各配置文件中的值用2.0作为后缀<br/><br>启动应用,访问配置信息的URL与配置文件的映射关系如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;dongarea&quot;,</span><br><span class="line">    &quot;profiles&quot;:[</span><br><span class="line">        &quot;prod&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;label&quot;:&quot;config-label-test&quot;,</span><br><span class="line">    &quot;version&quot;:&quot;4b2a044ee54afe2e849aa3b1d747a3d60aa959eb&quot;,</span><br><span class="line">    &quot;state&quot;:null,</span><br><span class="line">    &quot;propertySources&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;:&quot;http://git.oschina.net/dongarea/SpringCloud-Learning/spring_cloud_in_action/dongarea-prod.properties&quot;,</span><br><span class="line">            &quot;source&quot;:&#123;</span><br><span class="line">                &quot;from&quot;:&quot;git-prod-2.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;:&quot;http://git.oschina.net/dongarea/SpringCloud-Learning/spring_cloud_in_action/dongarea.properties&quot;,</span><br><span class="line">            &quot;source&quot;:&#123;</span><br><span class="line">                &quot;from&quot;:&quot;git-default-2.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="客户端配置映射"><a href="#客户端配置映射" class="headerlink" title="客户端配置映射"></a>客户端配置映射</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-config&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=dongarea</span><br><span class="line">spring.cloud.config.profile=dev</span><br><span class="line">spring.cloud.config.label=master</span><br><span class="line">spring.cloud.config.uri=http://localhost:7001/</span><br><span class="line">server.port=7002</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>spring.application.name</code>:对应配置文件规则中的{application}部分<br/><br><code>spring.cloud.config.profile</code>:对应配置文件规则中的{profile}部分<br/><br><code>spring.cloud.config.label</code>:对应配置文件规则中的{label}部分<br/><br><code>spring.cloud.config.uri</code>:配置中心config-server的地址<br/><br>这些属性必须配置在bootstrap.properties中,因为jar包之外的配置会优先</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RefreshScope</span><br><span class="line">@RestController</span><br><span class="line">public class TestController &#123;</span><br><span class="line">    @Value(&quot;$&#123;from&#125;&quot;)</span><br><span class="line">    private String from;</span><br><span class="line">    @RequestMapping(&quot;/from&quot;)</span><br><span class="line">    public String from()&#123;</span><br><span class="line">        return this.from;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动config-server应用,再启动config-client应用,访问<code>http://localhost:7002/from</code>,可以获取配置内容并输出对应环境的from内容</p>
<h1 id="服务端详解"><a href="#服务端详解" class="headerlink" title="服务端详解"></a>服务端详解</h1><h2 id="Git配置仓库"><a href="#Git配置仓库" class="headerlink" title="Git配置仓库"></a>Git配置仓库</h2><p>连接Git在线开发:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.server.git.uri=http://git.oschina.net/dongarea/SpringCloud-Learning/</span><br><span class="line">spring.cloud.config.server.git.search-paths=/spring_cloud_in_action</span><br><span class="line">spring.cloud.config.server.git.username=username</span><br><span class="line">spring.cloud.config.server.git.password=password</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>本地离线开发(仅供测试使用):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.server.git.uri=file://$&#123;user.name&#125;/config-repo</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="SVN配置仓库"><a href="#SVN配置仓库" class="headerlink" title="SVN配置仓库"></a>SVN配置仓库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.tmatesoft.svnkit&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;svnkit&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.8.10&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.server.svn.uri=svn://localhost:443/dongarea/SpringCloud-Learning/</span><br><span class="line">spring.cloud.config.server.svn.search-paths=/spring_cloud_in_action</span><br><span class="line">spring.cloud.config.server.svn.username=username</span><br><span class="line">spring.cloud.config.server.svn.password=password</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="本地文件系统"><a href="#本地文件系统" class="headerlink" title="本地文件系统"></a>本地文件系统</h2><p>使用本地文件系统的存储方式来保存配置信息,通过<code>spring.profiles.active=native</code>来实现<br/><br>指定具体的配置文件位置:<code>spring.cloud.config.server.native.searchLocations</code><br/><br>为了更好的内容管理和版本控制,建议还是使用Git仓库的方式</p>
<h2 id="安全保护"><a href="#安全保护" class="headerlink" title="安全保护"></a>安全保护</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-boot-starter-security&amp;lt;/artifactId&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>并修改配置文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security.user.name=user</span><br><span class="line">security.user.password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果在客户端不配置相应的安全信息,则会报下面的错误:<br/><br><img alt="Exception" src="https://img-blog.csdnimg.cn/20190330194640739.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>在客户端也配置上安全信息,则通过校验</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.username=user</span><br><span class="line">spring.cloud.config.password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种安全信息就像是暗号一样,需要双方都有才可以</p>
<h2 id="高可用配置"><a href="#高可用配置" class="headerlink" title="高可用配置"></a>高可用配置</h2><h1 id="客户端详解"><a href="#客户端详解" class="headerlink" title="客户端详解"></a>客户端详解</h1><h2 id="URI指定配置中心"><a href="#URI指定配置中心" class="headerlink" title="URI指定配置中心"></a>URI指定配置中心</h2><p>默认Spring Cloud Config会尝试连接<code>http://localhost:8888</code><br/><br>在<code>bootstrap.properties</code>中配置服务端配置中心地址,才会覆盖默认配置</p>
<h2 id="服务化配置中心"><a href="#服务化配置中心" class="headerlink" title="服务化配置中心"></a>服务化配置中心</h2><p>服务端配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-config-server&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-security&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-eureka&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=config-server</span><br><span class="line">server.port=7001</span><br><span class="line">#Git配置管理</span><br><span class="line">spring.cloud.config.server.git.uri=http://git.oschina.net/dongarea/SpringCloud-Learning/</span><br><span class="line">spring.cloud.config.server.git.search-paths=/spring_cloud_in_action</span><br><span class="line">spring.cloud.config.server.git.username=dongarea</span><br><span class="line">spring.cloud.config.server.git.password=j7k8l9;0</span><br><span class="line"></span><br><span class="line">security.user.name=user</span><br><span class="line">security.user.password=123456</span><br><span class="line">#配置服务注册中心</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableConfigServer</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-config&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-eureka&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=dongarea</span><br><span class="line">spring.cloud.config.profile=dev</span><br><span class="line">#指定服务注册中心,用于服务注册与发现</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka;</span><br><span class="line">server.port=7002</span><br><span class="line">#开启通过服务来访问Config Server的功能</span><br><span class="line">spring.cloud.config.discovery.enabled=true</span><br><span class="line">#指定Config Server注册的服务名</span><br><span class="line">spring.cloud.config.discovery.service-id=config-server</span><br><span class="line">spring.cloud.config.username=user</span><br><span class="line">spring.cloud.config.password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="失败快速响应与重试"><a href="#失败快速响应与重试" class="headerlink" title="失败快速响应与重试"></a>失败快速响应与重试</h2><p>在不启动config-server的情况下,启动客户端config-client时,会报错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#x27;scopedTarget.testController&#x27;: Injection of autowired dependencies failed;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要是在报错之前,已经加载了很多东西<br/><br>在bootstrap.properties中加上<code>spring.cloud.config.failFast=true</code>,直接验证config-server配置是否有误,加载信息少很多,达到了快速返回失败的效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: No instances found of configserver (config-server)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在网络波动等其他间隙性原因导致的问题时,可以开启重试功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.retry&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-retry&amp;lt;/artifactId&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-boot-starter-aop&amp;lt;/artifactId&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="获取远程配置"><a href="#获取远程配置" class="headerlink" title="获取远程配置"></a>获取远程配置</h2><p>通过URL和客户端配置的访问对应可以总结如下:</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B7%9F%E8%B8%AA-Spring%20Cloud%20Sleuth/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B7%9F%E8%B8%AA-Spring%20Cloud%20Sleuth/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–分布式服务跟踪-Spring-Cloud-Sleuth"><a href="#原创：SPRING-CLOUD微服务实战笔记–分布式服务跟踪-Spring-Cloud-Sleuth" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–分布式服务跟踪:Spring Cloud Sleuth"></a>原创：SPRING CLOUD微服务实战笔记–分布式服务跟踪:Spring Cloud Sleuth</h1><h3 id="Spring-Cloud-Sleuth"><a href="#Spring-Cloud-Sleuth" class="headerlink" title="Spring Cloud Sleuth"></a>Spring Cloud Sleuth</h3><h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-eureka&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-ribbon&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-boot-starter-test&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2)创建主类，实现&#x2F;trace-1接口，并使用RestTemplate调用trace-2应用的接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	private final Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">	@Bean</span><br><span class="line">	@LoadBalanced</span><br><span class="line">	RestTemplate restTemplate()&#123;</span><br><span class="line">		return new RestTemplate();</span><br><span class="line">	&#125;</span><br><span class="line">	@RequestMapping(value = &quot;/trace-1&quot;,method = RequestMethod.GET)</span><br><span class="line">	public String trace()&#123;</span><br><span class="line">		logger.info(&quot;===call trace-1====&quot;);</span><br><span class="line">		return restTemplate().getForEntity(&quot;http://trace-2/trace-2&quot;,String.class).getBody();</span><br><span class="line">	&#125;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3)在<code>application.properties</code>中，将<code>eureka.client.serviceUrl.defaultZone</code>参数指向<code>eureka-server</code>地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=trace-1</span><br><span class="line">server.port=9101</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">   private final Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">   @RequestMapping(value = &quot;/trace-2&quot;,method = RequestMethod.GET)</span><br><span class="line">   public String trace()&#123;</span><br><span class="line">   	logger.info(&quot;===&amp;lt;call trace-2&amp;gt;====&quot;);</span><br><span class="line">   	return &quot;Trace&quot;;</span><br><span class="line">   &#125;</span><br><span class="line">   public static void main(String[] args) &#123;</span><br><span class="line">   	SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3)在application.properties中，将eureka.client.serviceUrl.defaultZone参数指向eureka-server地址，并设置不同的应用名与端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=trace-2</span><br><span class="line">server.port=9102</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="实现跟踪"><a href="#实现跟踪" class="headerlink" title="实现跟踪"></a>实现跟踪</h2><p>在trace-1和trace-2的pom.xml依赖管理中增加<code>spring-cloud-starter-sleuth</code>依赖即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-sleuth&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.3.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重启trace-1和trace-2后，控制台打印发生变化，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO [trace-1,ddcf47da76da68c7,ddcf47da76da68c7,false] 70283 --- [nio-9101-exec-1] ication$$EnhancerBySpringCGLIB$$84347891 : ===call trace-1====</span><br><span class="line">INFO [trace-2,ddcf47da76da68c7,248958640a14c496,false] 70280 --- [nio-9102-exec-1] ication$$EnhancerBySpringCGLIB$$84347891 : ===&amp;lt;call trace-2&amp;gt;====</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到增加了<code>[trace-2,ddcf47da76da68c7,ddcf47da76da68c7,false]</code>类似的日志信息，含义如下：</p>
<h1 id="跟踪原理"><a href="#跟踪原理" class="headerlink" title="跟踪原理"></a>跟踪原理</h1><p>TraceID和SpanID是Spring Cloud Sleuth实现分布式服务跟踪的核心</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/trace-1&quot;,method = RequestMethod.GET)</span><br><span class="line">	public String trace(HttpServletRequest request)&#123;</span><br><span class="line">		logger.info(&quot;====&amp;lt;call trace-1&amp;gt;=====,TraceId=&#123;&#125;,SpanId=&#123;&#125;，ParentSpanId=&#123;&#125;,Sampled=&#123;&#125;,SpanName=&#123;&#125;&quot;</span><br><span class="line">				,request.getHeader(&quot;X-B3-TraceId&quot;),request.getHeader(&quot;X-B3-SpanId&quot;)</span><br><span class="line">				,request.getHeader(&quot;X-B3-ParentSpanId&quot;),request.getHeader(&quot;X-B3-Sampled&quot;),request.getHeader(&quot;X-Span-Name&quot;));</span><br><span class="line">		return restTemplate().getForEntity(&quot;http://trace-2/trace-2&quot;,String.class).getBody();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/trace-2&quot;,method = RequestMethod.GET)</span><br><span class="line">	public String trace(HttpServletRequest request)&#123;</span><br><span class="line">		logger.info(&quot;====&amp;lt;call trace-2&amp;gt;=====,TraceId=&#123;&#125;,SpanId=&#123;&#125;，ParentSpanId=&#123;&#125;,Sampled=&#123;&#125;,SpanName=&#123;&#125;&quot;</span><br><span class="line">				,request.getHeader(&quot;X-B3-TraceId&quot;),request.getHeader(&quot;X-B3-SpanId&quot;)</span><br><span class="line">				,request.getHeader(&quot;X-B3-ParentSpanId&quot;),request.getHeader(&quot;X-B3-Sampled&quot;),request.getHeader(&quot;X-Span-Name&quot;));</span><br><span class="line">		return &quot;Trace&quot;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.在trace-1和trace-2的<code>application.properties</code>中加入配置,可以更加直观的观察跟踪信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logging.level.org.springframework.web.servlet.DispatcherServlet=debug</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重启trace-1和trace-2的应用，可以看到<br/><br>trace-1的控制台<br/><br><img alt="trace-1" src="https://img-blog.csdnimg.cn/201904031455418.png"/><br/><br>trace-2的控制台<br/><br><img alt="trace-2" src="https://img-blog.csdnimg.cn/20190403145619545.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>trace-2中的<code>ParentSpanId</code>就是trace-1中的<code>SpanId</code>，trace-2中的<code>TraceId</code>与trace-1中的<code>TraceId</code>相同</p>
<h1 id="与Logstash整合"><a href="#与Logstash整合" class="headerlink" title="与Logstash整合"></a>与Logstash整合</h1><p>由于日志文件都离散地存储在各个服务实例的文件系统之上，引入基于日志的分析系统是一个不错的选择，比如ELK平台，它可以轻松地收集和存储跟踪日志，同时还可以根据TraceId搜索出对应请求链路相关的明细日志<br/><br>ELK平台主要由ElasticSearch、Logstash和Kibana三个工具组成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;net.logstash.logback&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;logstash-logback-encoder&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;4.6&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="与ZipKin整合"><a href="#与ZipKin整合" class="headerlink" title="与ZipKin整合"></a>与ZipKin整合</h1><p><img alt="Zipkin基础架构" src="https://img-blog.csdnimg.cn/20190403163504862.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>Collector:收集器组件，它主要处理从外部系统发过来的跟踪信息，将这些信息转换为Zipkin内部处理的Span格式，以支持后续的存储、分析、展示等功能<br/><br>Storage:存储组件，它主要处理收集器接收到的跟踪信息，默认会将这些信息存储在内存中。我们也可以修改此存储策略，通过使用其他存储组件将跟踪信息存储到数据库中。<br/><br>RESTful API:API组件，它主要用来提供外部访问接口。比如给客户端展示跟踪信息，或是外接系统访问以实现监控等。<br/><br>Web UI:UI组件，基于API组件实现的上层应用。通过UI组件，用户可以方便而又直观地查询和分析跟踪信息。</p>
<h2 id="HTTP收集"><a href="#HTTP收集" class="headerlink" title="HTTP收集"></a>HTTP收集</h2><p>第一步：搭建Zipkin Server</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;io.zipkin.java&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;zipkin-server&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;2.0.1&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;!-- https://mvnrepository.com/artifact/io.zipkin.java/zipkin-autoconfigure-ui --&amp;gt;</span><br><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;io.zipkin.java&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;zipkin-autoconfigure-ui&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;2.0.1&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@EnableZipkinServer</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=zipkin-server</span><br><span class="line">server.port=9411</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建完成后，启动工程，并访问<code>http://localhost:9411/</code>,可以看到如下Zipkin管理页面:<br/><br><img alt="Zipkin" src="https://img-blog.csdnimg.cn/20190403165516804.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>第二步：为应用引入和配置Zipkin服务<br/><br>在完成了Zipkin Server的搭建之后，还需要对应用做一些配置，以实现将跟踪信息输出到Zipkin Server。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-sleuth-zipkin&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.3.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.zipkin.base-url=http://localhost:9411</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重启eureka-server、trace-1、trace-2，发送请求<code>http://localhost:9101/trace-1</code>,可以查询出在日志中出现的跟踪信息<br/><br><img alt="Find Traces" src="https://img-blog.csdnimg.cn/20190403175723728.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>单击每一条记录，还能看到具体的跟踪信息<br/><br><img alt="跟踪信息" src="https://img-blog.csdnimg.cn/20190403175847209.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/></p>
<h2 id="消息中间件收集"><a href="#消息中间件收集" class="headerlink" title="消息中间件收集"></a>消息中间件收集</h2><p>第一步：修改客户端trace-1 和trace-2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-sleuth&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.3.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;!--注意下面的这个依赖必须注释掉，否则会报错，与上面的依赖冲突重复了--&amp;gt;</span><br><span class="line">&amp;lt;!--&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-sleuth-zipkin&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.3.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt; --&amp;gt;</span><br><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-sleuth-stream&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.3.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-stream-rabbit&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.3.4.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.rabbitmq.host=localhost</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=springcloud</span><br><span class="line">spring.rabbitmq.password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二步：修改zipkin-server服务端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependencies&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;io.zipkin.java&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;zipkin-server&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;2.0.1&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;io.zipkin.java&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;zipkin-autoconfigure-ui&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;2.0.1&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-sleuth-zipkin-stream&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.3.5.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">	&amp;lt;dependency&amp;gt;</span><br><span class="line">		&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">		&amp;lt;artifactId&amp;gt;spring-cloud-starter-stream-rabbit&amp;lt;/artifactId&amp;gt;</span><br><span class="line">		&amp;lt;version&amp;gt;1.3.4.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">	&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;/dependencies&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h2><p>默认情况下，Zipkin Server会将跟踪信息存储在内存中，一方面每次重启Zipkin Server都会使之前收集的跟踪信息丢失，另一方面当有大量跟踪信息时内存存储会成为瓶颈，所以通常情况下都会将跟踪信息对接到外部存储组件中去，比如使用MySQL存储</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--API%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1Spring%20Cloud%20Zuul/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-SPRING%20CLOUD%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0--API%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1Spring%20Cloud%20Zuul/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：SPRING-CLOUD微服务实战笔记–API网关服务Spring-Cloud-Zuul"><a href="#原创：SPRING-CLOUD微服务实战笔记–API网关服务Spring-Cloud-Zuul" class="headerlink" title="原创：SPRING CLOUD微服务实战笔记–API网关服务Spring Cloud Zuul"></a>原创：SPRING CLOUD微服务实战笔记–API网关服务Spring Cloud Zuul</h1><h3 id="Spring-Cloud-Zuul"><a href="#Spring-Cloud-Zuul" class="headerlink" title="Spring Cloud Zuul"></a>Spring Cloud Zuul</h3><h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><h2 id="构建网关"><a href="#构建网关" class="headerlink" title="构建网关"></a>构建网关</h2><p>API网关服务的构建过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-zuul&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line">&amp;lt;dependency&amp;gt;</span><br><span class="line">	&amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;</span><br><span class="line">	&amp;lt;artifactId&amp;gt;spring-cloud-starter-eureka&amp;lt;/artifactId&amp;gt;</span><br><span class="line">	&amp;lt;version&amp;gt;1.4.6.RELEASE&amp;lt;/version&amp;gt;</span><br><span class="line">&amp;lt;/dependency&amp;gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@EnableZuulProxy</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="请求路由"><a href="#请求路由" class="headerlink" title="请求路由"></a>请求路由</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=api-gateway</span><br><span class="line">server.port=5555</span><br><span class="line">zuul.routes.api-a.path=/api-a/**</span><br><span class="line">zuul.routes.api-a.serviceId=hello-service</span><br><span class="line">zuul.routes.api-b.path=/api-b/**</span><br><span class="line">zuul.routes.api-b.serviceId=feign-consumer</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:1111/eureka</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动服务后,查看eureka-server的信息面板,可以看到API-GATEWAY已经在列表中<br/><br><img alt="eureka-server面板" src="https://img-blog.csdnimg.cn/2019032722381578.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>经过配置,<code>http://localhost:5555/api-a/hello</code>符合<code>/api-a/**</code>的规则,最终<code>/hello</code>的请求会被发送到<code>hello-service</code>服务的某个实例上去<br/><br><code>http://localhost:5555/api-b/feign-consumer</code>符合<code>/api-b/**</code>的规则,最终<code>/feign-consumer</code>的请求会被发送到<code>feign-consumer</code>服务的某个实例上去</p>
<h2 id="请求过滤"><a href="#请求过滤" class="headerlink" title="请求过滤"></a>请求过滤</h2><p>定义一个类来继承ZuulFilter抽象类并重写下面4个方法来实现自定义的过滤器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//zuul过滤该请求,不对其路由</span><br><span class="line">ctx.setSendZuulResponse(false);</span><br><span class="line">//设置返回的错误码</span><br><span class="line">ctx.setResponseStatusCode(401);</span><br><span class="line">//对返回的body内容进行编辑</span><br><span class="line">ctx.setResponseBody(&quot;Your request has been lost!&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在实现了自定义过滤器之后,并不会直接生效,还需要在主类中创建具体的Bean</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@EnableZuulProxy</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class HelloApplication &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(HelloApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">	@Bean</span><br><span class="line">	public AccessFilter accessFilter()&#123;</span><br><span class="line">		return new AccessFilter();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总结Spring Cloud Zuul的优点:<br/><br>1)作为系统的统一入口,屏蔽了系统内部各个微服务的细节<br/><br>2)可以与服务治理框架结合,实现自动 化的服务实例维护以及负载均衡的路由转发<br/><br>3)可以实现接口权限校验与微服务业务逻辑的解耦<br/><br>4)通过服务网关中的过滤器,在各生命周期中去校验请求的内容,将原本在对外服务层做的校验前移,保证了微服务的无状态性,同时降低了微服务的测试难度,让服务本身更集中关注业务逻辑的处理</p>
<h1 id="路由详解"><a href="#路由详解" class="headerlink" title="路由详解"></a>路由详解</h1><h2 id="服务路由配置"><a href="#服务路由配置" class="headerlink" title="服务路由配置"></a>服务路由配置</h2><p>对于面向服务的路由配置,可以用<code>zuul.routes.user-service=/user-service/**</code>来配置<br/><br>在Eureka的帮助下,API网关服务自身就已经维护了系统中所有serviceId与实例地址的映射关系</p>
<h2 id="服务路由的默认规则"><a href="#服务路由的默认规则" class="headerlink" title="服务路由的默认规则"></a>服务路由的默认规则</h2><p>Spring Cloud Zuul构建的API网关服务引入Spring Cloud Eureka之后,它为Eureka中的每个服务都自动创建一个默认路由规则<br/><br>对于不希望对外开放的服务可以通过<code>zuul.ignored-services</code>参数来设置一个服务名匹配表达式来定义不自动创建服务的规则,然后在配置文件中通过<code>zuul.routes.&amp;lt;serviceId&amp;gt;=&amp;lt;path&amp;gt;</code>配置方式来创建路由,其他的依然是使用默认规则</p>
<h2 id="本地跳转"><a href="#本地跳转" class="headerlink" title="本地跳转"></a>本地跳转</h2><p>在Zuul实现的API网关路由功能中,还支持forward形式的服务端跳转配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zuul.routes.api-a.path=/api-a/**</span><br><span class="line">zuul.routes.api-a.url=http://localhost:8001/</span><br><span class="line">zuul.routes.api-b.path=/api-b/**</span><br><span class="line">zuul.routes.api-b.url=forward:/local</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当接收到&#x2F;api-b&#x2F;hello的请求,对于<code>api-b</code>的路由规则生效,请求会被转发到网关的&#x2F;local&#x2F;hello请求上进行本地处理,所以需要增加一个&#x2F;local&#x2F;hello的接口实现才可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HelloController&#123;</span><br><span class="line">	@RequestMapping(&quot;/local/hello&quot;)</span><br><span class="line">	public String hello()&#123;</span><br><span class="line">		return &quot;Hello World Local&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Cookie和头信息"><a href="#Cookie和头信息" class="headerlink" title="Cookie和头信息"></a>Cookie和头信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#方法一:对指定路由开启自定义敏感头</span><br><span class="line">zuul.routes.&amp;lt;router&amp;gt;.customSensitiveHeaders=true</span><br><span class="line">#方法二:将指定路由的敏感头设置为空</span><br><span class="line">zuul.routes.&amp;lt;router&amp;gt;.sensitiveHeaders=</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>仅对指定的Web应用开启对敏感信息的传递,影响范围小,不至于引起其他服务的信息泄露问题<br/><br>重定向问题描述:在登录完成后,通过重定向的方式跳到登录后的页面,指向了具体的服务实例地址<br/><br>重定向问题解决方案:网关在进行路由转发之前为请求设置Host头信息,以标识最初的服务端请求地址,具体配置如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul.addHostHeader=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Hystrix和Ribbon支持"><a href="#Hystrix和Ribbon支持" class="headerlink" title="Hystrix和Ribbon支持"></a>Hystrix和Ribbon支持</h2><p>Zuul拥有线程隔离和断路器自我保护功能,以及对服务调用的客户端负载均衡功能<br/><br>当使用path和url的映射关系来配置路由的时候,不会采用HystrixCommand来包装,所以这类路由请求没有线程隔离和断路器的保护,并且也不会有负载均衡的能力.<br/><br>所以,尽量使用path和serviceId的组合来进行配置,这样不仅保证API网关的健壮和稳定,也能用到Ribbon的客户端负载均衡功能<br/><br>在使用Zuul搭建API网关的时候,可以通过Hystrix和Ribbon的参数来调整路由请求的各种超时时间等配置<br/><br>在有些情况下,可能需要关闭重试机制,可以使用下面的配置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#全局关闭重试机制</span><br><span class="line">zuul.retryable=false</span><br><span class="line">#指定路由关闭重试机制</span><br><span class="line">zuul.routes.&amp;lt;route&amp;gt;.retryable=false</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="过滤器详解"><a href="#过滤器详解" class="headerlink" title="过滤器详解"></a>过滤器详解</h1><h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>在Spring Cloud Zuul中实现的过滤器必须包含4个基本特征:过滤类型,执行顺序,执行条件,具体操作,具体含义前面已经讲过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String filterType();</span><br><span class="line">int filterOrder();</span><br><span class="line">boolean shouldFilter();</span><br><span class="line">Object run();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="请求生命周期"><a href="#请求生命周期" class="headerlink" title="请求生命周期"></a>请求生命周期</h2><p>一个HTTP请求到达API网关之后,如何在各种不同类型的过滤器之间流转的详细过程<br/><br><img alt="请求生命周期图解" src="https://img-blog.csdnimg.cn/20190328132332213.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>第一阶段pre:在进行请求路由之前做一些前置加工<br/><br>第二阶段routing:将外部请求转发到具体服务实例上去的过程,当服务实例将请求结果都返回之后,routing阶段完成,请求进入第三阶段post<br/><br>第三阶段post:此类型的过滤器在处理的时候不仅可以获取到请求信息,还能获取到服务实例的返回信息,所以在post类型的过滤器中,可以对处理结果进行一些加工或者转换等内容<br/><br>特殊阶段error:此阶段只有上述三个阶段中发生异常时才会触发,但是最后的流向还是post过滤器,需要通过post过滤器将最终结果返回给请求客户端</p>
<h2 id="禁用过滤器"><a href="#禁用过滤器" class="headerlink" title="禁用过滤器"></a>禁用过滤器</h2><p>对于过滤器不想使用了,想要禁用,在Zuul中特别提供了一个参数来禁用指定的过滤器,参数配置格式如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul.&amp;lt;SimpleClassName&amp;gt;.&amp;lt;filterType&amp;gt;.disable=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中<code>&amp;lt;SimpleClassName&amp;gt;</code>代表过滤器的类名,比如AccessFilter<br/><br><code>&amp;lt;filterType&amp;gt;</code>代表过滤器类型,比如AccessFilter的pre类型<br/><br>比如想要禁用AccessFilter过滤器,只要在application.properties配置文件中增加如下配置:<br/><br><code>zuul.AccessFilter.pre.disable=true</code><br/><br>这样就可以禁用Spring Cloud Zuul中默认定义的核心过滤器,来实现一套更符合实际需求的处理机制</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-shell%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E2%80%94%E2%80%94%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-shell%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E2%80%94%E2%80%94%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：shell文本处理——正则表达式"><a href="#原创：shell文本处理——正则表达式" class="headerlink" title="原创：shell文本处理——正则表达式"></a>原创：shell文本处理——正则表达式</h1><h2 id="正则表达式的类型"><a href="#正则表达式的类型" class="headerlink" title="正则表达式的类型"></a>正则表达式的类型</h2><p>正则表达式是通过正则表达式引擎来实现的。正则表达式引擎是一套底层软件，负责解释正则表达式模式并使用这些模式进行文本匹配。<br/><br>Linux中，有两种流行的正则表达式引擎：</p>
<h2 id="纯文本"><a href="#纯文本" class="headerlink" title="纯文本"></a>纯文本</h2><p>纯文本比较简单，就不多说了。只要注意几点：<br/><br>1.正则表达式模式都区分大小写<br/><br>2.正则表达式不用写出完整的单词，匹配到部分单词即可</p>
<h2 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a>特殊字符</h2><p>正则表达式识别的特殊字符包括：<br/><br>.*[]^${}+?|()<br/><br>如果要使用某个特殊字符作为文本字符，就必须转义。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ sed -n &#x27;/\$/p&#x27; data2</span><br><span class="line">The cost is $4.00</span><br><span class="line">➜  Charpter20 git:(master) ✗ cat data2</span><br><span class="line">The cost is $4.00</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="锚字符"><a href="#锚字符" class="headerlink" title="锚字符"></a>锚字符</h2><p>有两个特殊字符可以用来将模式锁定在数据流中的行首或行尾<br/><br>1.锁定在行首<br/><br>脱字符(^)定义从数据流中文本行的行首开始的模式。如果模式出现在行首之外的位置，正则表达式模式则无法匹配。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;The book store&quot;|sed -n &#x27;/^book/p&#x27;</span><br><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;Books are great&quot;|sed -n &#x27;/^Book/p&#x27;</span><br><span class="line">Books are great</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果将脱字符放到模式开头之外的其他位置，那么它就跟普通字符一样，不再是特殊字符了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;This is^ a test&quot;|sed -n &#x27;/s^/p&#x27;</span><br><span class="line">This is^ a test</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.锁定在行尾<br/><br>特殊字符美元符($)定义了行尾锚点。将这个特殊字符放在文本模式之后来指明数据行必须以该文本模式结尾。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;This is a good book&quot;|sed -n &#x27;/book$/p&#x27;</span><br><span class="line">This is a good book</span><br><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;This is a good &quot;|sed -n &#x27;/book$/p&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.组合锚点<br/><br>在一些情况下，可以在同一行中将行首锚点和行尾锚点组合在一起使用。<br/><br>如删除数据流中的空白行，可以如下操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ more data3</span><br><span class="line">This is one test line.</span><br><span class="line"></span><br><span class="line">This is another test line.</span><br><span class="line">➜  Charpter20 git:(master) ✗ sed &#x27;/^$/d&#x27; data3</span><br><span class="line">This is one test line.</span><br><span class="line">This is another test line.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以通过这种方式生成一个没有空行的文件，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ sed &#x27;/^$/d;w data4&#x27; data3</span><br><span class="line">This is one test line.</span><br><span class="line">This is another test line.</span><br><span class="line">➜  Charpter20 git:(master) ✗ more data4</span><br><span class="line">This is one test line.</span><br><span class="line">This is another test line.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="点号字符"><a href="#点号字符" class="headerlink" title="点号字符"></a>点号字符</h2><p>点号代表任意字符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;This is a very nice hat&quot;|sed -n &#x27;/.at/p&#x27;</span><br><span class="line">This is a very nice hat</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="字符组"><a href="#字符组" class="headerlink" title="字符组"></a>字符组</h2><p>使用方括号来定义一个字符组。方括号包含所有希望出现在该字符组中的字符。<br/><br>在不太确定某个字符的大小写时，字符组会很有用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;Yes&quot;|sed -n &#x27;/[Yy]es/p&#x27;</span><br><span class="line">Yes</span><br><span class="line">➜  Charpter20 git:(master) ✗ echo &quot;yes&quot;|sed -n &#x27;/[Yy]es/p&#x27;</span><br><span class="line">yes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="排除型字符组"><a href="#排除型字符组" class="headerlink" title="排除型字符组"></a>排除型字符组</h2><p>在正则表达式中，也可以反转字符组的作用，可以寻找组中没有的字符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ more data6</span><br><span class="line">This is a test of a line.</span><br><span class="line">The cat is sleeping.</span><br><span class="line">That is a very nice hat.</span><br><span class="line">This test is at line four.</span><br><span class="line">at ten o&#x27;clock we&#x27;ll go home.</span><br><span class="line">➜  Charpter20 git:(master) ✗ sed -n &#x27;/[^ch]at/p&#x27; data6</span><br><span class="line">This test is at line four.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="区间"><a href="#区间" class="headerlink" title="区间"></a>区间</h2><p>对于邮编使用区间的方式来进行过滤不满足规则的邮编，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ sed -n &#x27;/^[0-9][0-9][0-9][0-9][0-9]$/p&#x27; data8</span><br><span class="line">60633</span><br><span class="line">46201</span><br><span class="line">22203</span><br><span class="line">➜  Charpter20 git:(master) ✗ more data8</span><br><span class="line">60633</span><br><span class="line">46201</span><br><span class="line">223001</span><br><span class="line">4353</span><br><span class="line">22203</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还可以在单个字符组指定多个不连续的区间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  Charpter20 git:(master) ✗ sed -n &#x27;/[a-ch-m]at/p&#x27; data6</span><br><span class="line">The cat is sleeping.</span><br><span class="line">That is a very nice hat.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="特殊的字符组"><a href="#特殊的字符组" class="headerlink" title="特殊的字符组"></a>特殊的字符组</h2><p>除了定义自己的字符组外，BRE还包含了一些特殊的字符组，可用来匹配特定类型的字符。下表介绍了可用的BRE特殊的字符组。</p>
<th align="center">选项</th><th align="center">描述</th>
|------
<td align="center">[[:alpha:]]</td><td align="center">匹配任意字母字符，不管是大写还是小写</td>
<td align="center">[[:alnum:]]</td><td align="center">匹配任意字母数字字符0<sub>9、A</sub>Z或a~z</td>
<td align="center">[[:blank:]]</td><td align="center">匹配空格或制表符</td>
<td align="center">[[:digit:]]</td><td align="center">匹配0~9之间的数字</td>
<td align="center">[[:lower:]]</td><td align="center">匹配小写字母字符a~z</td>
<td align="center">[[:print:]]</td><td align="center">匹配任意可打印字符</td>
<td align="center">[[:punct:]]</td><td align="center">匹配标点符号</td>
<td align="center">[[:space:]]</td><td align="center">匹配任意空白字符：空格、制表符、NL、FF、VT和CR</td>
<td align="center">[[:upper:]]</td><td align="center">匹配任意大写字母字符A~Z</td>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;abc&quot;|sed -n &#x27;/[[:digit:]]/p&#x27;</span><br><span class="line">[root@ommleft zd]# echo &quot;abc&quot;|sed -n &#x27;/[[:alnum:]]/p&#x27;</span><br><span class="line">abc</span><br><span class="line">[root@ommleft zd]# echo &quot;abc123&quot;|sed -n &#x27;/[[:alnum:]]/p&#x27;</span><br><span class="line">abc123</span><br><span class="line">[root@ommleft zd]# echo &quot;This is , a test&quot;|sed -n &#x27;/[[:punct:]]/p&#x27;</span><br><span class="line">This is , a test</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="扩展正则表达式"><a href="#扩展正则表达式" class="headerlink" title="扩展正则表达式"></a>扩展正则表达式</h2><p>gawk程序可以使用大多数扩展正则表达式模式符号，并且能提供一些额外过滤功能，而这些功能都是sed编辑器所不具备的。但正因为如此，gawk程序在处理数据流时通常比较慢。</p>
<h2 id="问号"><a href="#问号" class="headerlink" title="问号"></a>问号</h2><p>问号表明前面的字符可以出现0次或1次，但只限于此。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;bt&quot;|gawk &#x27;/be?t/&#123;print $0&#125;&#x27;</span><br><span class="line">bt</span><br><span class="line">[root@ommleft zd]# echo &quot;bet&quot;|gawk &#x27;/be?t/&#123;print $0&#125;&#x27;</span><br><span class="line">bet</span><br><span class="line">[root@ommleft zd]# echo &quot;beet&quot;|gawk &#x27;/be?t/&#123;print $0&#125;&#x27;</span><br><span class="line">[root@ommleft zd]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="加号"><a href="#加号" class="headerlink" title="加号"></a>加号</h2><p>加号类似于星号的另一个模式符号，但跟问号也有不同。加号表明前面的字符可以出现1次或多次，但必须至少出现1次。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;beeet&quot;|gawk &#x27;/be+t/&#123;print $0&#125;&#x27;</span><br><span class="line">beeet</span><br><span class="line">[root@ommleft zd]# echo &quot;bt&quot;|gawk &#x27;/be+t/&#123;print $0&#125;&#x27;</span><br><span class="line">[root@ommleft zd]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="花括号"><a href="#花括号" class="headerlink" title="花括号"></a>花括号</h2><p>花括号允许为可重复的正则表达式指定一个上限。这通常称为间隔。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;bet&quot;|gawk &#x27;/be&#123;1&#125;t/&#123;print $0&#125;&#x27;</span><br><span class="line">bet</span><br><span class="line">[root@ommleft zd]# echo &quot;beet&quot;|gawk &#x27;/be&#123;1&#125;t/&#123;print $0&#125;&#x27;</span><br><span class="line">[root@ommleft zd]#</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="管道符号"><a href="#管道符号" class="headerlink" title="管道符号"></a>管道符号</h2><p>管道符号允许你在检查数据流时，用逻辑OR方式指定正则表达式引擎要用的两个或多个模式。如果任何一个模式匹配了数据流文本，文本就通过了测试。<br/><br>使用管道符号的格式如下：<br/><br>expr1|expr2|…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;The cat is asleep&quot;|gawk &#x27;/cat|dog/&#123;print $0&#125;&#x27;</span><br><span class="line">The cat is asleep</span><br><span class="line">[root@ommleft zd]# echo &quot;The dog is asleep&quot;|gawk &#x27;/cat|dog/&#123;print $0&#125;&#x27;</span><br><span class="line">The dog is asleep</span><br><span class="line">[root@ommleft zd]# echo &quot;The sleep is asleep&quot;|gawk &#x27;/cat|dog/&#123;print $0&#125;&#x27;</span><br><span class="line">[root@ommleft zd]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="表达式分组"><a href="#表达式分组" class="headerlink" title="表达式分组"></a>表达式分组</h2><p>正则表达式可以用圆括号进行分组。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;Sat&quot;|gawk &#x27;/Sat(urday)?/&#123;print $0&#125;&#x27;</span><br><span class="line">Sat</span><br><span class="line">[root@ommleft zd]# echo &quot;Saturday&quot;|gawk &#x27;/Sat(urday)?/&#123;print $0&#125;&#x27;</span><br><span class="line">Saturday</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-shell%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E2%80%94%E2%80%94sed%E7%BC%96%E8%BE%91%E5%99%A8%E5%9F%BA%E7%A1%80%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-shell%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E2%80%94%E2%80%94sed%E7%BC%96%E8%BE%91%E5%99%A8%E5%9F%BA%E7%A1%80%E7%AF%87/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：shell文本处理——sed编辑器基础篇"><a href="#原创：shell文本处理——sed编辑器基础篇" class="headerlink" title="原创：shell文本处理——sed编辑器基础篇"></a>原创：shell文本处理——sed编辑器基础篇</h1><h2 id="替换选项"><a href="#替换选项" class="headerlink" title="替换选项"></a>替换选项</h2><p>1.替换标记<br/><br>在替换的时候，会出现如下情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more data4.txt</span><br><span class="line">This is a test of the test script.</span><br><span class="line">This is the second test of the test script.</span><br><span class="line">[root@ommleft zd]# sed &#x27;s/test/trial/&#x27; data4.txt</span><br><span class="line">This is a trial of the test script.</span><br><span class="line">This is the second trial of the test script.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>只能替换第一处匹配的情况，若要替换不同地方出现的文本，则必须使用替换标记。<br/><br>替换标记使用方式如下：<br/><br>s&#x2F;pattern&#x2F;replacement&#x2F;flags<br/><br>有4种可用的替换标记：<br/><br>-数字，表明新文本将替换第几处模式匹配的地方</p>
<p>使用数字指定匹配行中位置，如下匹配行中的第二处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;s/test/trial/2&#x27; data4.txt</span><br><span class="line">This is a test of the trial script.</span><br><span class="line">This is the second test of the trial script.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用g匹配所有情况，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;s/test/trial/g&#x27; data4.txt</span><br><span class="line">This is a trial of the trial script.</span><br><span class="line">This is the second trial of the trial script.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用p会打印出原来的行，感觉用处不大，举例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;s/test/trial/p&#x27; data4.txt</span><br><span class="line">This is a trial of the test script.</span><br><span class="line">This is a trial of the test script.</span><br><span class="line">This is the second trial of the test script.</span><br><span class="line">This is the second trial of the test script.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以同时使用多个替换标记,如下同时使用g和p：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;s/test/trial/gp&#x27; data4.txt</span><br><span class="line">This is a trial of the trial script.</span><br><span class="line">This is a trial of the trial script.</span><br><span class="line">This is the second trial of the trial script.</span><br><span class="line">This is the second trial of the trial script.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用w file,将替换结果写入文件中，如下将替换结果写入到test.txt中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;s/test/trial/w test.txt&#x27; data4.txt</span><br><span class="line">This is a trial of the test script.</span><br><span class="line">This is the second trial of the test script.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.替换字符<br/><br>在写脚本的时候经常会遇到一些不太方便在替换模式中使用的字符，如常用的正斜线（&#x2F;）<br/><br>如：sed  ‘s&#x2F;&#x2F;bin&#x2F;bash&#x2F;&#x2F;bin&#x2F;csh&#x2F;’   &#x2F;etc&#x2F;passwd<br/><br>上面例子中使用转义符进行转义，会造成困惑，可以使用其他字符来替换命令中的字符分隔符：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed  &#x27;s!/bin/bash!/bin/csh!&#x27;  /etc/passwd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上例中，使用感叹号作为分隔符，路径就比较明显了。</p>
<h2 id="使用地址"><a href="#使用地址" class="headerlink" title="使用地址"></a>使用地址</h2><p>如果只将命令作用于特定行或者某些行，则必须用行寻址（line  addressing）.<br/><br>在sed编辑中有两种形式的行寻址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[address] command</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以将特定地址的多个命令分组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">address &#123;</span><br><span class="line">    command1</span><br><span class="line">    command2</span><br><span class="line">    command3</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.数字方式的行寻址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;2s/test/trail/&#x27; data4.txt</span><br><span class="line">This is a test of the test script.</span><br><span class="line">This is the second trail of the test script.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>sed编辑器只修改了地址指定的第二行的文本。同时还可以设置行地址区间，例如修改第2，3行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more data1.txt</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">[root@ommleft zd]# sed &#x27;2,3s/dog/cat/&#x27; data1.txt </span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以修改从某行到文末的所有行,当不知道文本有多少行的时候，此种方法使用起来非常方便：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;3,$s/dog/cat/&#x27; data1.txt</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.使用文本模式过滤器<br/><br>通过文本模式可以使用字符串方式直接替换匹配的行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# grep zternc /etc/passwd</span><br><span class="line">zternc:x:1005:1006::/home/zte/PM:/bin/bash</span><br><span class="line">[root@ommleft zd]# sed &#x27;/zternc/s/bash/csh/&#x27; /etc/passwd</span><br><span class="line">zternc:x:1005:1006::/home/zte/PM:/bin/csh</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.命令组合<br/><br>如果需要在单行上执行多条命令，可以用花括号来讲多条命令组合在一起。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;2&#123;</span><br><span class="line">&amp;gt; s/test/trail/</span><br><span class="line">&amp;gt; s/This/That/</span><br><span class="line">&amp;gt; s/script/text/</span><br><span class="line">&amp;gt; &#125;&#x27; data4.txt</span><br><span class="line">This is a test of the test script.</span><br><span class="line">That is the second trail of the test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者用分号隔开</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;2&#123;s/test/trail/;s/This/That/;s/script/text/&#125;&#x27; data4.txt</span><br><span class="line">This is a test of the test script.</span><br><span class="line">That is the second trail of the test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="删除行"><a href="#删除行" class="headerlink" title="删除行"></a>删除行</h2><p>如果需要删除文本流中的特定行，可以用删除命令d。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line">[root@ommleft zd]# sed &#x27;2d&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>另外文本模式匹配方式也可以用来删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;/Two/d&#x27; data2.txt </span><br><span class="line">One line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还可以跳跃式删除行，如下只删除第1行和第3行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;1d;3d&#x27; data2.txt</span><br><span class="line">Two line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用时注意，有时匹配不到不会报错，而是一直删除下去，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;/One/,/Five/d&#x27; data2.txt</span><br><span class="line">[root@ommleft zd]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面例子中，当匹配到”One”之后，会打开行删除功能，之后由于找不到”Five”，会一直删除下去，导致输出为空</p>
<h2 id="插入和附加文本"><a href="#插入和附加文本" class="headerlink" title="插入和附加文本"></a>插入和附加文本</h2><p>sed编辑器允许想数据流中插入和附加文本行：<br/><br>1）插入（insert）命令（i）会在指定行前增加一个新行；<br/><br>2）附加（append）命令（a）会在指定行后增加一个新行；<br/><br>可以指定在某行前插入文本，如下所示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;3i\This is an inserted line.&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">This is an inserted line.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者在某行后附加文本，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;3a\This is an appended line.&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line">This is an appended line.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果想要在文末追加使用如下操作,无需知道最后一行的行号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;$a\This is an appended line.&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line">This is an appended line.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要插入或附加多行文本，就必须对要插入或附加的新文本中的每一行使用反斜线，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;1i\</span><br><span class="line">&amp;gt; This is one line of new line\</span><br><span class="line">&amp;gt; This is another line of new line.&#x27; data2.txt</span><br><span class="line">This is one line of new line</span><br><span class="line">This is another line of new line.</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>指定的两行都会被添加到数据流中。</p>
<h2 id="修改行"><a href="#修改行" class="headerlink" title="修改行"></a>修改行</h2><p>修改（change）命令允许修改数据流中整行文本的内容。它跟插入和附加的工作机制相同，都需要指定新行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;2c\Second line.&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Second line.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>另外还支持文本模式寻址，如下利用文本模式来匹配第二行进行修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;/Two/c\This is Second line.&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">This is Second line.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用地址区间来修改时，要注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more data1.txt</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">[root@ommleft zd]# sed &#x27;2,3c\This is changed.&#x27; data1.txt</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">This is changed.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上例中没有逐一修改第二行和第三行，而是两行使用新行来修改，使用时需要注意。</p>
<h2 id="转换命令"><a href="#转换命令" class="headerlink" title="转换命令"></a>转换命令</h2><p>转换（transform）命令（y）是唯一可以处理单个字符的sed编辑器命令。转换命令格式如下：<br/><br>[address]y&#x2F;inchars&#x2F;outchars&#x2F;<br/><br>转换命令会对inchars和outchars值进行一对一的映射。这个映射过程会一直持续到处理完指定字符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more data5.txt</span><br><span class="line">This is line number 1.</span><br><span class="line">This is line number 2.</span><br><span class="line">This is line number 3.</span><br><span class="line">This is line number 4.</span><br><span class="line">This is line number 1 again.</span><br><span class="line">This is yet another line.</span><br><span class="line">This is the last line in the file.</span><br><span class="line">[root@ommleft zd]# sed &#x27;y/123/789/&#x27; data5.txt</span><br><span class="line">This is line number 7.</span><br><span class="line">This is line number 8.</span><br><span class="line">This is line number 9.</span><br><span class="line">This is line number 4.</span><br><span class="line">This is line number 7 again.</span><br><span class="line">This is yet another line.</span><br><span class="line">This is the last line in the file.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当inchars和outchars长度不同时，会报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;y/12/789/&#x27; data5.txt</span><br><span class="line">sed:-e 表达式 #1，字符9：‘y&#x27;命令的字符串长度不同</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h2><p>sed命令中用来输出数据流打印信息：<br/><br>1）p命令用来打印文本行<br/><br>2）等号（&#x3D;）命令用来打印行号<br/><br>3）l (小写的L)命令用来列出行<br/><br>1.打印行<br/><br>用来打印已有的行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;/Two/p&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通常在文本模式进行匹配时，与-n同时使用,隐藏其他不相关的行，只显示匹配的行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed -n &#x27;/Two/p&#x27; data2.txt</span><br><span class="line">Two line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果想要在替换之前查看原来的行，可以使用如下操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed -n &#x27;/text/&#123;</span><br><span class="line">&amp;gt; p</span><br><span class="line">&amp;gt; s/line/String/p</span><br><span class="line">&amp;gt; &#125;&#x27; data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">One String of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Two String of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line">Three String of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上例中，对于匹配到“text”的行进行替换，使用此方式，可以方便比较文本的变化。<br/><br>2.打印行号<br/><br>可以通过等号（&#x3D;）来打印行号，可以查看匹配文本的行号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed -n &#x27;/Two/&#123;</span><br><span class="line">&amp;gt; =</span><br><span class="line">&amp;gt; p</span><br><span class="line">&amp;gt; &#125;&#x27; data2.txt</span><br><span class="line">2</span><br><span class="line">Two line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.列出行<br/><br>列出（list）命令（l）可以打印数据流中的文本和不可打印的ASCII字符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more data6.txt</span><br><span class="line">THis	line	contains	tabs.</span><br><span class="line">[root@ommleft zd]# sed -n &#x27;l&#x27; data6.txt</span><br><span class="line">THis\tline\tcontains\ttabs.$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上例中制表符的位置使用\t来显示。行尾的美元符表示换行符。</p>
<h2 id="使用sed处理文件"><a href="#使用sed处理文件" class="headerlink" title="使用sed处理文件"></a>使用sed处理文件</h2><p>1.写入文件<br/><br>w命令用来向文件中写入行。该命令格式如下：<br/><br>[address]w  filename<br/><br>filename可以是相对路径或者绝对路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed -n &#x27;1,3w /home/omm/zd/test3.txt&#x27; data3.txt</span><br><span class="line">[root@ommleft zd]# more test3.txt</span><br><span class="line">Line 1</span><br><span class="line">Line 2</span><br><span class="line">Line 3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>若是想要通过公用的文本创建一个数据文件，可以使用此方法来生成。<br/><br>比如想使用公共文件&#x2F;etc&#x2F;passwd生成root用户的所有配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed -n &#x27;/^root/w root.txt&#x27; /etc/passwd</span><br><span class="line">[root@ommleft zd]# more root.txt</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.从文件读取数据<br/><br>读取（read)命令（r）允许将一个独立文件中的数据插入到数据流中<br/><br>读取命令的格式如下：<br/><br>[address]r filename<br/><br>filename参数指定了数据文件的绝对路径或者相对路径。sed编辑器会将文件中的文本插入到指定地址之后。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more data3.txt</span><br><span class="line">Line 1</span><br><span class="line">Line 2</span><br><span class="line">Line 3</span><br><span class="line">[root@ommleft zd]# more data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line">[root@ommleft zd]# sed &#x27;/Line 2/r data2.txt&#x27; data3.txt</span><br><span class="line">Line 1</span><br><span class="line">Line 2</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line">Line 3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上例中将data2.txt中的文本插入到匹配文本行（Line 2）之后，当然也可以使用<code>sed &#39;2r data2.txt&#39; data3.txt</code>来进行插入。<br/><br>使用读取数据和删除数据来进行替换文本内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more notice.std </span><br><span class="line">Would the following people:</span><br><span class="line">List</span><br><span class="line">please report to the ship&#x27;s captain.</span><br><span class="line">[root@ommleft zd]# more root.txt</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">[root@ommleft zd]# sed &#x27;/List/&#123;</span><br><span class="line">&amp;gt; r root.txt</span><br><span class="line">&amp;gt; d</span><br><span class="line">&amp;gt; &#125;&#x27; notice.std</span><br><span class="line">Would the following people:</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">please report to the ship&#x27;s captain.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，使用读取文件命令（r root.txt）和删除文本命令（d）将”List”处的文本替换为了root.txt中的内容，此处List起到了占位符的作用。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-shell%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E2%80%94%E2%80%94gawk%E5%92%8Csed%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-shell%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E2%80%94%E2%80%94gawk%E5%92%8Csed%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：shell文本处理——gawk和sed简介"><a href="#原创：shell文本处理——gawk和sed简介" class="headerlink" title="原创：shell文本处理——gawk和sed简介"></a>原创：shell文本处理——gawk和sed简介</h1><h2 id="gawk程序"><a href="#gawk程序" class="headerlink" title="gawk程序"></a>gawk程序</h2><p>gawk程序时Unix中的原始awk程序的GNU版本。在gawk编程语言中，可以做如下的事情：</p>
<p>2.使用数据字段变量<br/><br>默认情况下，gawk会将如下变量分配给它在文本行中发现的数据字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# cat data2.txt</span><br><span class="line">One line of test text.</span><br><span class="line">Two line of test text.</span><br><span class="line">Three line of test text.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# gawk &#x27;&#123;print $1&#125;&#x27; data2.txt</span><br><span class="line">One</span><br><span class="line">Two</span><br><span class="line">Three</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用字段分隔符来读取文件，可以使用-F选项指定</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# gawk -F: &#x27;&#123;print $1&#125;&#x27; /etc/passwd</span><br><span class="line">root</span><br><span class="line">bin</span><br><span class="line">daemon</span><br><span class="line">adm</span><br><span class="line">lp</span><br><span class="line">sync</span><br><span class="line">shutdown</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.从程序脚本中使用多个命令<br/><br>要在命令行上的程序脚本中使用多条命令，可以在命令之间放个分号即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;My name is Rich&quot;|gawk &#x27;&#123;$4=&quot;Christine&quot;;print $0&#125;&#x27;</span><br><span class="line">My name is Christine</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.从文件中读取程序<br/><br>gawk编辑器允许将程序存储到文件中，然后在命令行中引用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# more script.gawk</span><br><span class="line">&#123;print $1 &quot;&#x27;s home directory is &quot; $6&#125;</span><br><span class="line">[root@ommleft zd]# gawk -F: -f script.gawk /etc/passwd</span><br><span class="line">root&#x27;s home directory is /root</span><br><span class="line">bin&#x27;s home directory is /bin</span><br><span class="line">daemon&#x27;s home directory is /sbin</span><br><span class="line">adm&#x27;s home directory is /var/adm</span><br><span class="line">lp&#x27;s home directory is /var/spool/lpd</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.gawk BEGIN<br/><br>gawk中的BEGIN关键字会强制gawk在读取数据前执行BEGIN关键字后指定的程序脚本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# gawk &#x27;BEGIN&#123;print &quot;Hello World!&quot;&#125;&#x27;</span><br><span class="line">Hello World!</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>读取文本并显示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# cat data3.txt</span><br><span class="line">Line 1</span><br><span class="line">Line 2</span><br><span class="line">Line 3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ommleft zd]# gawk &#x27;BEGIN &#123;print &quot;The data3 file contents:&quot;&#125;&#123;print $0&#125;&#x27; data3.txt</span><br><span class="line">The data3 file contents:</span><br><span class="line">Line 1</span><br><span class="line">Line 2</span><br><span class="line">Line 3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.gawk END<br/><br>与BEGIN关键字相似，END关键字允许指定一个程序脚本，gawk会在读完数据之后执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# gawk &#x27;BEGIN&#123;print &quot;The data3 file contents:&quot;&#125;</span><br><span class="line">&#123;print $0&#125;</span><br><span class="line">END&#123;print &quot;End of File&quot;&#125;&#x27; data3.txt</span><br><span class="line">The data3 file contents:</span><br><span class="line">Line 1</span><br><span class="line">Line 2</span><br><span class="line">Line 3</span><br><span class="line">End of File</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="sed编辑器"><a href="#sed编辑器" class="headerlink" title="sed编辑器"></a>sed编辑器</h2><p>sed编辑器被称作流编辑器（stream editor），sed编辑器会执行如下操作：<br/><br>1）一次从输入中读取一行数据。<br/><br>2）根据所提供的编辑器命令匹配数据<br/><br>3）按照命令修改流中的数据<br/><br>4）将新的数据输出到STDOUT<br/><br>sed命令的格式如下：<br/><br>sed options  script   file<br/><br>sed命令选项如下：<br/><br>|选项|描述|<br/><br>|-e command|将指定的命令添加到已有命令中|<br/><br>|-f  file|将file中指定的命令添加到已有命令中|<br/><br>|-n |不产生命令输出，使用print命令完成输出|</p>
<p>1.在命令行定义编辑器命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# echo &quot;This is a test&quot;|sed &#x27;s/test/trial/&#x27; </span><br><span class="line">This is a trial</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还可以对文件数据进行处理，输出STDOUT,但并不会修改文件中的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# cat data1.txt</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line">The quick brown fox jumps over the lazy dog.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed &#x27;s/dog/cat/&#x27; data1.txt</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line">The quick brown fox jumps over the lazy cat.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.在命令行使用多个编辑器命令<br/><br>要在sed命令行上执行多个命令时，只要用-e选项就可以了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# sed -e &#x27;s/brown/green/;s/dog/cat/&#x27; data1.txt</span><br><span class="line">The quick green fox jumps over the lazy cat.</span><br><span class="line">The quick green fox jumps over the lazy cat.</span><br><span class="line">The quick green fox jumps over the lazy cat.</span><br><span class="line">The quick green fox jumps over the lazy cat.</span><br><span class="line">The quick green fox jumps over the lazy cat.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.从文件中读取编辑器命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ommleft zd]# cat script.sed</span><br><span class="line">s/brown/green/</span><br><span class="line">s/fox/elephant/</span><br><span class="line">s/dog/cat/</span><br><span class="line">[root@ommleft zd]# sed -f script.sed data1.txt</span><br><span class="line">The quick green elephant jumps over the lazy cat.</span><br><span class="line">The quick green elephant jumps over the lazy cat.</span><br><span class="line">The quick green elephant jumps over the lazy cat.</span><br><span class="line">The quick green elephant jumps over the lazy cat.</span><br><span class="line">The quick green elephant jumps over the lazy cat.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-Shell%E7%9A%84%E9%83%A8%E5%88%86%E5%86%85%E5%A4%96%E5%BB%BA%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-Shell%E7%9A%84%E9%83%A8%E5%88%86%E5%86%85%E5%A4%96%E5%BB%BA%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：Shell的部分内外建命令"><a href="#原创：Shell的部分内外建命令" class="headerlink" title="原创：Shell的部分内外建命令"></a>原创：Shell的部分内外建命令</h1><h2 id="内建命令"><a href="#内建命令" class="headerlink" title="内建命令"></a>内建命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd  is  a  shell  builtin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>cd命令是内建命令，可以通过type命令来查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo   is  a   shell  builtin</span><br><span class="line">echo  is  /bin/echo</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>echo既有内建命令也有外部命令，可以通过type  -a 方式查看</p>
<h2 id="外部命令"><a href="#外部命令" class="headerlink" title="外部命令"></a>外部命令</h2><p>外部命令可以通过which和type命令来找到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/ps</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ps就是一个外部命令<br/><br>对于多种实现的命令，既有内建命令又有外部命令的命令，如pwd<br/><br>若要使用外部命令pwd,则可以输入&#x2F;bin&#x2F;pwd</p>
<h2 id="命令别名"><a href="#命令别名" class="headerlink" title="命令别名"></a>命令别名</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-Shell%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-Shell%E7%BC%96%E7%A8%8B%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%AF%86/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：Shell编程的一些常识"><a href="#原创：Shell编程的一些常识" class="headerlink" title="原创：Shell编程的一些常识"></a>原创：Shell编程的一些常识</h1><p>虽然写过些shell脚本了，但是对于很多知识还是记忆不深刻。在看书的过程中，正好看到了相关常识，在此记录下以备后用。</p>
<h2 id="执行数学运算"><a href="#执行数学运算" class="headerlink" title="执行数学运算"></a>执行数学运算</h2><p>1.expr命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  /etc expr 1 + 5</span><br><span class="line">6</span><br><span class="line">➜  /etc expr 1 * 5</span><br><span class="line">expr: syntax error</span><br><span class="line">➜  /etc expr 1 \* 5</span><br><span class="line">5</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注：1）数字与符号之间要有空格<br/><br>2）个别符号需要转义，如上例中的星号（*）</p>
<p>2.使用方括号<br/><br>在bash中，在将一个数学运算结果赋给某个变量时，可以用美元符合方括号（$[ operation ]）将数学表达式围起来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  /etc var1=$[1 + 5]</span><br><span class="line">➜  /etc echo $var1</span><br><span class="line">6</span><br><span class="line">➜  /etc var2=$[$var1 * 2]</span><br><span class="line">➜  /etc echo $var2</span><br><span class="line">12</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在使用方括号来计算公式时，不用担心shell会误解乘号或者其他符号，这是一大优点。</p>
<h2 id="浮点数运算"><a href="#浮点数运算" class="headerlink" title="浮点数运算"></a>浮点数运算</h2><p>有时候会遇到浮点数算术操作，最常见的方案是用内建的bash计算器，叫做bc.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  /etc bc -q</span><br><span class="line">3.44 / 5</span><br><span class="line">0</span><br><span class="line">scale=4</span><br><span class="line">3.44 / 5</span><br><span class="line">.6880</span><br><span class="line">quit</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上例中，-q是不显示bash计算器的欢迎信息。scale变量用来设置计算结果保留的小数位数。<br/><br>在shell中的运用方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variable=$(echo &quot;options; expression&quot;|bc)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第一部分options允许设置变量，如果不止一个变量，可以使用分号将其分开。<br/><br>expression参数定义了通过bc执行的数学表达式。例子如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  /etc var1=$(echo &quot;scale=4;3.44 / 5&quot;|bc)</span><br><span class="line">➜  /etc echo $var1</span><br><span class="line">.6880</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="数值比较"><a href="#数值比较" class="headerlink" title="数值比较"></a>数值比较</h2><p>数值比较可以说是shell编程中最为常见的了，直接影响着流程的走向，因此对于数值比较知识点的掌握也极其重要了。</p>
<th align="center">比较</th><th align="center">描述</th>
|------
<td align="center">n1 -eq n2</td><td align="center">检查n1是否与n2相等</td>
<td align="center">n1 -ge n2</td><td align="center">检查n1是否大于或等于n2</td>
<td align="center">n1 -gt n2</td><td align="center">检查n1是否大于n2</td>
<td align="center">n1 -le n2</td><td align="center">检查n1是否小于或者等于n2</td>
<td align="center">n1 -lt n2</td><td align="center">检查n1是否小于n2</td>
<td align="center">n1 -ne n2</td><td align="center">检查n1是否不等于n2</td>

<h2 id="字符串比较"><a href="#字符串比较" class="headerlink" title="字符串比较"></a>字符串比较</h2><p>条件还允许比较字符串值。</p>
<th align="center">比较</th><th align="center">描述</th>
|------
<td align="center">str1 = str2</td><td align="center">检查str1是否和str2相同</td>
<td align="center">str1 != str2</td><td align="center">检查str1是否和str2不同</td>
<td align="center">str1 &lt; str2</td><td align="center">检查str1是否比str2小</td>
<td align="center">str1 &gt; str2</td><td align="center">检查str1是否比str2大</td>
<td align="center">-n str1</td><td align="center">检查str1的长度是否非0</td>
<td align="center">-z str1</td><td align="center">检查str1的长度是否为0</td>

<h2 id="文件比较"><a href="#文件比较" class="headerlink" title="文件比较"></a>文件比较</h2><p>文件比较在shell编程中也是用的最多的比较形式。用于测试Linux文件系统上文件和目录的状态。</p>
<th align="center">比较</th><th align="center">描述</th>
|------
<td align="center">-d file</td><td align="center">检查file是否存在并是一个目录</td>
<td align="center">-e file</td><td align="center">检查file是否存在</td>
<td align="center">-f file</td><td align="center">检查file是否存在并是一个文件</td>
<td align="center">-r file</td><td align="center">检查file是否存在并可读</td>
<td align="center">-s file</td><td align="center">检查file是否存在并非空</td>
<td align="center">-w file</td><td align="center">检查file是否存在并可写</td>
<td align="center">-x file</td><td align="center">检查file是否存在并可执行</td>
<td align="center">-O file</td><td align="center">检查file是否存在并属于当前用户所有</td>
<td align="center">-G file</td><td align="center">检查file是否存在并且默认组与当前用户相同</td>
<td align="center">file1 -nt file2</td><td align="center">检查file1是否比file2新</td>
<td align="center">file1 -ot file2</td><td align="center">检查file1是否比file2旧</td>

<h2 id="复合条件测试"><a href="#复合条件测试" class="headerlink" title="复合条件测试"></a>复合条件测试</h2><p>if-then语句允许使用布尔逻辑来组合测试，两种布尔运算符可用：</p>
<h2 id="if-then的高级特性"><a href="#if-then的高级特性" class="headerlink" title="if-then的高级特性"></a>if-then的高级特性</h2><p>bash-shell提供了两项可在if-then语句中使用的高级特性：</p>
<p>1.使用双括号<br/><br>双括号的命令格式如下：<br/><br>((  expression ))<br/><br>expression可以是任意的数学赋值或比较表达式。<br/><br>2.使用双方括号<br/><br>双方括号的命令格式如下：<br/><br>[[ expression ]]<br/><br>双方括号提供了模式匹配的功能。<br/><br>如： [[ $USR &#x3D;&#x3D; r* ]]可用来判断用户是否是以字母r开头</p>
<h2 id="CASE命令"><a href="#CASE命令" class="headerlink" title="CASE命令"></a>CASE命令</h2><p>通过case命令不用写出冗长的if-then-else语句，而可以通过列表的方式来检查变量的多个值。<br/><br>格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">case variable in</span><br><span class="line">pattern1 | pattern2) commands1;;</span><br><span class="line">pattern3) commands2;;</span><br><span class="line">*) commands;;</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>case命令会将指定的变量与不同模式进行比较。如果变量和模式是匹配的，那么SHELL会执行为该模式指定的命令。可以通过竖线操作符在一行中分隔多个模式。星号(*)会捕获所有与已知模式不匹配的值。仔细一看，这个和JAVA的case非常相似。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://lengendofdong.github.io/2022/07/31/%E5%8E%9F%E5%88%9B-shell%20source%20sh%20bash%E4%B8%8E.-%E7%9A%84%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/31/%E5%8E%9F%E5%88%9B-shell%20source%20sh%20bash%E4%B8%8E.-%E7%9A%84%E5%8C%BA%E5%88%AB/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-31 15:58:18 / Modified: 15:51:32" itemprop="dateCreated datePublished" datetime="2022-07-31T15:58:18+08:00">2022-07-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="原创：shell-source-sh-bash与-x2F-的区别"><a href="#原创：shell-source-sh-bash与-x2F-的区别" class="headerlink" title="原创：shell source sh bash与.&#x2F;的区别"></a>原创：shell source sh bash与.&#x2F;的区别</h1><h1 id="source的使用"><a href="#source的使用" class="headerlink" title="source的使用"></a>source的使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source FileName</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>作用:在当前bash环境下读取并执行FileName中的命令。该filename文件可以无”执行权限”<br/><br>注：该命令通常用命令“.”来替代。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source .bash_profile</span><br><span class="line">. .bash_profile</span><br><span class="line">两者等效</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>source通常用来生效刚刚修改的文件</p>
<h1 id="sh与bash的使用"><a href="#sh与bash的使用" class="headerlink" title="sh与bash的使用"></a>sh与bash的使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh FileName</span><br><span class="line"> bash FileName</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>作用:在当前bash环境下读取并执行FileName中的命令。该filename文件可以无”执行权限”<br/><br>注：两者在执行文件时的不同，是分别用自己的shell来跑文件。</p>
<h1 id="x2F-的使用"><a href="#x2F-的使用" class="headerlink" title=".&#x2F;的使用"></a>.&#x2F;的使用</h1><p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200109101618427.png"/><br/><br>作用:打开一个子shell来读取并执行FileName中命令。<br/><br>注：运行一个shell脚本时会启动另一个命令解释器.<br/><br>注：需要加权限才可以执行。</p>
<h1 id="source-sh-bash-与-x2F-的区别"><a href="#source-sh-bash-与-x2F-的区别" class="headerlink" title="source sh bash 与.&#x2F;的区别"></a>source sh bash 与.&#x2F;的区别</h1><p>如下例子中，展示source 、sh、bash与.&#x2F;的区别：<br/><br>结论一:脚本加上执行权限后，.&#x2F;<strong>.sh, sh .&#x2F;</strong>.sh与bash .&#x2F;*.sh相同，此三种执行脚本的方式都是重新启动一个子shell,在子shell中执行此脚本。</p>
<p>结论二: source  *.sh和.  *.sh的执行方式是等价的，即两种执行方式都是在当前shell进程中执行此脚本，而不是重新启动一个shell 而在子shell进程中执行此脚本。<br/><br><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2020010910011516.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5nZG9uZzEyMzQ1,size_16,color_FFFFFF,t_70"/><br/><br>验证依据：没有被export导出的变量（即非环境变量）是不能被子shell继承的<br/><br><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200109102437144.png"/></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
